#!/usr/bin/env sh
echo "ğŸ” Pre-commit ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
STAGED_FILES=$(git diff --cached --name-only)

# next-app/ å†…ã¨ ã‚¤ãƒ³ãƒ•ãƒ©ãƒ•ã‚¡ã‚¤ãƒ«(.husky/, .github/) ä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
NON_NEXT_APP_FILES=$(echo "$STAGED_FILES" | grep -v "^next-app/" | grep -v "^\.husky/" | grep -v "^\.github/" | grep -v "^\.cursor/" | grep -v "^docs/" | grep -v "^db/")

if [ -n "$NON_NEXT_APP_FILES" ]; then
  # å®Ÿéš›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆsrc/, contracts/ç­‰ï¼‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  SOURCE_FILES=$(echo "$NON_NEXT_APP_FILES" | grep -E "^(src/|contracts/|supabase/functions/|tests/)")
  
  if [ -n "$SOURCE_FILES" ]; then
    # ãƒ«ãƒ¼ãƒˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‹ãƒã‚§ãƒƒã‚¯
    echo "ğŸ“ ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’æ¤œå‡ºã€‚å‹ãƒã‚§ãƒƒã‚¯ & Lint ã‚’å®Ÿè¡Œ..."
    [ -f package.json ] && { pnpm typecheck || true; pnpm lint || true; }
  else
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å¤‰æ›´ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    echo "âš ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å¤‰æ›´ã‚’æ¤œå‡ºã€‚å‹ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
  fi
else
  # next-app/ ã¨ã‚¤ãƒ³ãƒ•ãƒ©ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å ´åˆã€next-app/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ãƒã‚§ãƒƒã‚¯
  echo "ğŸ“ next-app/ å†…ã®å¤‰æ›´ã®ã¿ã‚’æ¤œå‡ºã€‚next-app/ ã§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ..."
  if [ -f next-app/package.json ]; then
    cd next-app
    pnpm typecheck || true
    pnpm lint || true
    cd ..
  fi
fi

# DDLå¤‰æ›´æ¤œçŸ¥ â†’ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆè­¦å‘Šã®ã¿ï¼‰
CHANGED_FILES=$(git diff --cached --name-only)
if echo "$CHANGED_FILES" | grep -qE "\b(db/ddl/|db/migrations/|prisma/migrations/)"; then
  echo "âš ï¸ DDL/ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’æ¤œå‡ºã€‚"
  echo "ğŸ“‹ ã‚³ãƒŸãƒƒãƒˆå¾Œã«ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:"
  echo "  [ ] å½±éŸ¿ç¯„å›²: pnpm schema:impact -- --table <t> [--column <c>]"
  echo "  [ ] å‹å†ç”Ÿæˆ: pnpm gen:db-types && pnpm codegen"
  echo "  [ ] ãƒ†ã‚¹ãƒˆ: pnpm test || true"
fi

echo "âœ… OK"

