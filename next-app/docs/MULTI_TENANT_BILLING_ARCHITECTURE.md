# ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè«‹æ±‚ã‚·ã‚¹ãƒ†ãƒ  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2025-10-21  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**é©ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: BABAå»ƒæ£„ç‰©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [çµ„ç¹”æ§‹é€ ](#çµ„ç¹”æ§‹é€ )
3. [è«‹æ±‚ãƒ•ãƒ­ãƒ¼](#è«‹æ±‚ãƒ•ãƒ­ãƒ¼)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«](#ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«)
5. [æ¨©é™ç®¡ç†](#æ¨©é™ç®¡ç†)
6. [å®Ÿè£…ã‚¬ã‚¤ãƒ‰](#å®Ÿè£…ã‚¬ã‚¤ãƒ‰)
7. [ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹](#ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹)

---

## æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€**ç®¡ç†ä¼šç¤¾ï¼ˆBABAæ ªå¼ä¼šç¤¾ï¼‰**ãŒè¤‡æ•°ã®**æ’å‡ºä¼æ¥­ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰**ã®å»ƒæ£„ç‰©ç®¡ç†ã‚’å—è¨—ã™ã‚‹ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå‹ã®è«‹æ±‚ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### ä¸»è¦ãªç™»å ´äººç‰©

| å½¹å‰² | èª¬æ˜ | ä¾‹ |
|------|------|-----|
| **æ’å‡ºä¼æ¥­ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰** | å»ƒæ£„ç‰©ã‚’æ’å‡ºã™ã‚‹ä¼æ¥­ | ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ã€æ¥½å¸‚æ¥½åº§ |
| **ç®¡ç†ä¼šç¤¾ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼‰** | ãƒ†ãƒŠãƒ³ãƒˆã®å»ƒæ£„ç‰©ç®¡ç†ã‚’å—è¨— | BABAæ ªå¼ä¼šç¤¾ |
| **åé›†æ¥­è€…** | å„ãƒ†ãƒŠãƒ³ãƒˆå°‚ç”¨ã®åé›†æ¥­è€… | ã‚¨ã‚³å›åæ±æ—¥æœ¬ã€ã‚¨ã‚³ã‚¯ãƒªãƒ¼ãƒ³æ±æµ· |

---

## çµ„ç¹”æ§‹é€ 

### éšå±¤æ§‹é€ 

```
ã€ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæ§‹é€ ã€‘

æ’å‡ºä¼æ¥­ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰A: ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“æ ªå¼ä¼šç¤¾
  org_id: 00000000-0000-0000-0000-000000000001
  org_type: EMITTER
  â”‚
  â”œâ”€ ç®¡ç†ä¼šç¤¾: BABAæ ªå¼ä¼šç¤¾ï¼ˆå—è¨—ç®¡ç†ï¼‰
  â”‚   org_id: 12345678-1234-1234-1234-123456789012
  â”‚   org_type: ADMIN
  â”‚   role: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¨ã—ã¦å…¨ãƒ†ãƒŠãƒ³ãƒˆã‚’ç®¡ç†
  â”‚
  â”œâ”€ åé›†æ¥­è€…ï¼ˆã‚³ã‚¹ãƒ¢ã‚¹è–¬å“å°‚ç”¨ï¼‰
  â”‚   â”œâ”€ ã‚¨ã‚³å›åæ±æ—¥æœ¬ï¼ˆorg_id = ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ï¼‰
  â”‚   â””â”€ ãƒªã‚µã‚¤ã‚¯ãƒ«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚ºåŒ—æ—¥æœ¬ï¼ˆorg_id = ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ï¼‰
  â”‚
  â”œâ”€ åº—èˆ—ï¼ˆorg_id = ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ï¼‰
  â”‚   â””â”€ å°å€‰åº—ã€å¤§é˜ªåº—ã€...
  â”‚
  â””â”€ è«‹æ±‚æ˜ç´°ï¼ˆorg_id = ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ï¼‰


æ’å‡ºä¼æ¥­ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰B: æ¥½å¸‚æ¥½åº§æ ªå¼ä¼šç¤¾
  org_id: 00000000-0000-0000-0000-000000000004
  org_type: EMITTER
  â”‚
  â”œâ”€ ç®¡ç†ä¼šç¤¾: BABAæ ªå¼ä¼šç¤¾ï¼ˆå—è¨—ç®¡ç†ï¼‰
  â”‚
  â”œâ”€ åé›†æ¥­è€…ï¼ˆæ¥½å¸‚æ¥½åº§å°‚ç”¨ï¼‰
  â”‚   â”œâ”€ ã‚¨ã‚³ã‚¯ãƒªãƒ¼ãƒ³æ±æµ·ï¼ˆorg_id = æ¥½å¸‚æ¥½åº§ï¼‰
  â”‚   â””â”€ ã‚°ãƒªãƒ¼ãƒ³ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚ºé–¢è¥¿ï¼ˆorg_id = æ¥½å¸‚æ¥½åº§ï¼‰
  â”‚
  â”œâ”€ åº—èˆ—ï¼ˆorg_id = æ¥½å¸‚æ¥½åº§ï¼‰
  â”‚   â””â”€ åå¤å±‹æ „åº—ã€å¤§é˜ªé›£æ³¢åº—ã€...
  â”‚
  â””â”€ è«‹æ±‚æ˜ç´°ï¼ˆorg_id = æ¥½å¸‚æ¥½åº§ï¼‰
```

### é‡è¦ãªè¨­è¨ˆåŸå‰‡

1. âœ… **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢**: å„ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯ `org_id` ã§å®Œå…¨ã«åˆ†é›¢
2. âœ… **åé›†æ¥­è€…ã®æ‰€å±**: åé›†æ¥­è€…ã¯å„ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å±ï¼ˆ`org_id = ãƒ†ãƒŠãƒ³ãƒˆ`ï¼‰
3. âœ… **ç®¡ç†ä¼šç¤¾ã®æ¨©é™**: ç®¡ç†ä¼šç¤¾ã¯å…¨ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
4. âœ… **è«‹æ±‚æ˜ç´°ã®æ‰€å±**: è«‹æ±‚æ˜ç´°ã¯å„ãƒ†ãƒŠãƒ³ãƒˆã«ç´ä»˜ãï¼ˆ`org_id = ãƒ†ãƒŠãƒ³ãƒˆ`ï¼‰

---

## è«‹æ±‚ãƒ•ãƒ­ãƒ¼

### å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
ã€è«‹æ±‚ã®æµã‚Œã€‘

Step 1: å›åå®Ÿç¸¾è¨˜éŒ²ï¼ˆåé›†æ¥­è€…ï¼‰
  åé›†æ¥­è€…ã€Œã‚¨ã‚³å›åæ±æ—¥æœ¬ã€ï¼ˆorg_id = ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ï¼‰
  â””â”€ ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ã®åº—èˆ—ã§å›å
  â””â”€ å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²
      â†’ actuals (org_id = ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“)

Step 2: è«‹æ±‚æ˜ç´°ä½œæˆï¼ˆåé›†æ¥­è€…ï¼‰
  åé›†æ¥­è€…ã€Œã‚¨ã‚³å›åæ±æ—¥æœ¬ã€
  â””â”€ å›åå®Ÿç¸¾ã‹ã‚‰è«‹æ±‚æ˜ç´°ã‚’è‡ªå‹•ç”Ÿæˆ
      â†’ app_billing_items.create({
           org_id: ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“,
           collector_id: ã‚¨ã‚³å›åæ±æ—¥æœ¬,
           store_id: å°å€‰åº—,
           amount: 10,000å††
         })

Step 3: è«‹æ±‚å†…å®¹ç¢ºèªãƒ»èª¿æ•´ï¼ˆç®¡ç†ä¼šç¤¾ï¼‰
  BABAæ ªå¼ä¼šç¤¾ã®ç®¡ç†è€…ãŒãƒ­ã‚°ã‚¤ãƒ³
  â””â”€ ãƒ†ãƒŠãƒ³ãƒˆé¸æŠ: ğŸ¥ ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“
  â””â”€ è«‹æ±‚æ˜ç´°ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆorg_id = ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ï¼‰
  â””â”€ è«‹æ±‚å†…å®¹ã‚’ç¢ºèª
  â””â”€ æ‰‹æ•°æ–™ã‚’è¿½åŠ ãƒ»èª¿æ•´
      â†’ app_billing_items.update({
           amount: 10,500å††ï¼ˆæ‰‹æ•°æ–™5%è¾¼ã¿ï¼‰,
           notes: "ç®¡ç†æ‰‹æ•°æ–™: 500å††"
         })

Step 4: è«‹æ±‚æ›¸ç¢ºå®šãƒ»ç™ºè¡Œï¼ˆç®¡ç†ä¼šç¤¾ï¼‰
  BABAæ ªå¼ä¼šç¤¾
  â””â”€ è«‹æ±‚ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
  â””â”€ è«‹æ±‚æ›¸PDFå‡ºåŠ›
  â””â”€ ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ã«è«‹æ±‚æ›¸ã‚’ç™ºè¡Œ
      è«‹æ±‚å…ƒ: BABAæ ªå¼ä¼šç¤¾ï¼ˆç®¡ç†ä¼šç¤¾ã¨ã—ã¦ï¼‰
      è«‹æ±‚å…ˆ: ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“æ ªå¼ä¼šç¤¾
```

### ç®¡ç†ä¼šç¤¾ã®å½¹å‰²

| å½¹å‰² | å®Ÿæ–½å†…å®¹ |
|------|---------|
| **ãƒ‡ãƒ¼ã‚¿ç¢ºèª** | åé›†æ¥­è€…ã‹ã‚‰ã®è«‹æ±‚æ˜ç´°ã‚’ç¢ºèª |
| **æ‰‹æ•°æ–™ä»˜åŠ ** | ç®¡ç†æ‰‹æ•°æ–™ï¼ˆå›ºå®šé¡ or ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰ã‚’è¿½åŠ  |
| **è«‹æ±‚æ›¸ç¢ºå®š** | æœ€çµ‚çš„ãªè«‹æ±‚é‡‘é¡ã‚’ç¢ºå®š |
| **è«‹æ±‚æ›¸ç™ºè¡Œ** | å„ãƒ†ãƒŠãƒ³ãƒˆå‘ã‘ã«è«‹æ±‚æ›¸PDFå‡ºåŠ› |

**é‡è¦**: ç®¡ç†ä¼šç¤¾ã¯å®Ÿç¸¾å ±å‘Šã‚’è¡Œã‚ãªã„ï¼ˆåé›†æ¥­è€…ã®ã¿ï¼‰

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ org_id ã®é–¢ä¿‚

| ãƒ†ãƒ¼ãƒ–ãƒ« | org_id | èª¬æ˜ |
|---------|--------|------|
| `organizations` | è‡ªèº«ã®ID | çµ„ç¹”ãƒã‚¹ã‚¿ãƒ¼ |
| `collectors` | ãƒ†ãƒŠãƒ³ãƒˆã®ID | åé›†æ¥­è€…ã¯ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å± |
| `stores` | ãƒ†ãƒŠãƒ³ãƒˆã®ID | åº—èˆ—ã¯ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å± |
| `plans` | ãƒ†ãƒŠãƒ³ãƒˆã®ID | åé›†äºˆå®šã¯ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å± |
| `actuals` | ãƒ†ãƒŠãƒ³ãƒˆã®ID | å›åå®Ÿç¸¾ã¯ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å± |
| `app_billing_items` | ãƒ†ãƒŠãƒ³ãƒˆã®ID | è«‹æ±‚æ˜ç´°ã¯ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å± |
| `billing_summaries` | ãƒ†ãƒŠãƒ³ãƒˆã®ID | è«‹æ±‚ã‚µãƒãƒªãƒ¼ã¯ãƒ†ãƒŠãƒ³ãƒˆã«æ‰€å± |

### è«‹æ±‚æ˜ç´°ï¼ˆapp_billing_itemsï¼‰ã®æ§‹é€ 

```prisma
model app_billing_items {
  id                    String              @id
  org_id                String              // â† ãƒ†ãƒŠãƒ³ãƒˆã®ID
  collector_id          String              // åé›†æ¥­è€…ID
  store_id              String?             // åº—èˆ—ID
  billing_month         DateTime            // è«‹æ±‚æœˆ
  item_name             String              // å“ç›®å
  quantity              Float?              // æ•°é‡
  unit_price            Float?              // å˜ä¾¡
  amount                Float               // å°è¨ˆï¼ˆæ‰‹æ•°æ–™å‰ï¼‰
  tax_rate              Float               // ç¨ç‡
  tax_amount            Float               // ç¨é¡
  total_amount          Float               // åˆè¨ˆï¼ˆæ‰‹æ•°æ–™è¾¼ã¿ï¼‰
  status                String              // DRAFT, SUBMITTED, APPROVED, PAID
  notes                 String?             // å‚™è€ƒï¼ˆæ‰‹æ•°æ–™è©³ç´°ãªã©ï¼‰
  created_by            String?
  updated_by            String?
  // ...
}
```

---

## æ¨©é™ç®¡ç†

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»çµ„ç¹”ãƒ»æ¨©é™ã®é–¢ä¿‚

```typescript
// AuthUser ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
export interface AuthUser {
  id: string                // app_users.id
  email: string             // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  org_id: string            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ org_idï¼ˆæœ€åˆã®çµ„ç¹”ï¼‰
  org_ids: string[]         // å…¨æ‰€å±çµ„ç¹”ã® org_id é…åˆ—
  role: string              // ADMIN, EMITTER, etc.
  isAdmin: boolean          // çµ„ç¹”ç®¡ç†è€…ãƒ•ãƒ©ã‚°
  isSystemAdmin: boolean    // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒ•ãƒ©ã‚°ï¼ˆorg_type = ADMINï¼‰
}
```

### ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®åˆ¤å®š

```typescript
// getAuthenticatedUser() ã§ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
const isSystemAdmin = dbUser.user_org_roles.some(
  r => r.organizations.org_type === 'ADMIN'
);
```

### ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€…ï¼‰

```typescript
// è‡ªåˆ†ã®ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º
const billingItems = await prisma.app_billing_items.findMany({
  where: {
    org_id: user.org_id,
    deleted_at: null,
  },
});
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼ˆé¸æŠã•ã‚ŒãŸãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ï¼‰

```typescript
// ãƒ†ãƒŠãƒ³ãƒˆé¸æŠã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
const { searchParams } = new URL(request.url);
const selectedOrgId = searchParams.get('org_id');

// ç®¡ç†å¯èƒ½ãªçµ„ç¹”ã‹ç¢ºèª
if (!user.org_ids.includes(selectedOrgId)) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}

const billingItems = await prisma.app_billing_items.findMany({
  where: {
    org_id: selectedOrgId,
    deleted_at: null,
  },
});
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼ˆå…¨ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ï¼‰

```typescript
// å…¨ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬è¡¨ç¤ºï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãªã©ï¼‰
const billingItems = await prisma.app_billing_items.findMany({
  where: {
    org_id: { in: user.org_ids.filter(id => id !== ADMIN_ORG_ID) },
    deleted_at: null,
  },
});
```

---

## å®Ÿè£…ã‚¬ã‚¤ãƒ‰

### 1. èªè¨¼ãƒ»æ¨©é™ç®¡ç†

#### session-server.ts ã®ä¿®æ­£

```typescript
// next-app/src/lib/auth/session-server.ts

export interface AuthUser {
  id: string
  email: string
  org_id: string
  org_ids: string[]         // ğŸ†• è¿½åŠ 
  role: string
  isAdmin: boolean
  isSystemAdmin: boolean    // ğŸ†• è¿½åŠ 
}

export async function getAuthenticatedUser(
  request: NextRequest
): Promise<AuthUser | null> {
  // ... Supabase Auth æ¤œè¨¼ ...

  const dbUser = await prisma.app_users.findFirst({
    where: { auth_user_id: user.id },
    include: {
      user_org_roles: {
        where: { is_active: true },
        include: {
          organizations: true,
        },
      },
    },
  })

  // ğŸ†• ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…åˆ¤å®š
  const isSystemAdmin = dbUser.user_org_roles.some(
    r => r.organizations.org_type === 'ADMIN'
  );

  const primaryOrgRole = dbUser.user_org_roles[0];

  return {
    id: dbUser.id,
    email: dbUser.email,
    org_id: primaryOrgRole.org_id,
    org_ids: dbUser.user_org_roles.map(r => r.org_id),
    role: primaryOrgRole.role,
    isAdmin: primaryOrgRole.role === 'ADMIN',
    isSystemAdmin,
  }
}
```

---

### 2. APIå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

#### ç®¡ç†å¯èƒ½ãƒ†ãƒŠãƒ³ãƒˆä¸€è¦§API

```typescript
// next-app/src/app/api/organizations/managed-tenants/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { getAuthenticatedUser } from '@/lib/auth/session-server';
import { prisma } from '@/lib/prisma';

export async function GET(request: NextRequest) {
  const user = await getAuthenticatedUser(request);
  
  if (!user || !user.isSystemAdmin) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  const tenants = await prisma.organizations.findMany({
    where: {
      id: { in: user.org_ids },
      org_type: 'EMITTER',
      deleted_at: null,
    },
    select: {
      id: true,
      name: true,
      code: true,
    },
  });

  return NextResponse.json({ data: tenants });
}
```

#### è«‹æ±‚æ˜ç´°APIï¼ˆãƒ†ãƒŠãƒ³ãƒˆé¸æŠå¯¾å¿œï¼‰

```typescript
// next-app/src/app/api/billing-items/route.ts

export async function GET(request: NextRequest) {
  const user = await getAuthenticatedUser(request);
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { searchParams } = new URL(request.url);
  
  let targetOrgId = user.org_id;
  
  if (user.isSystemAdmin) {
    const selectedOrgId = searchParams.get('org_id');
    
    if (selectedOrgId && user.org_ids.includes(selectedOrgId)) {
      targetOrgId = selectedOrgId;
    } else if (!selectedOrgId) {
      // å…¨ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿
      const allBillingItems = await prisma.app_billing_items.findMany({
        where: {
          org_id: { in: user.org_ids },
          deleted_at: null,
        },
      });
      return NextResponse.json({ data: allBillingItems });
    }
  }

  const billingItems = await prisma.app_billing_items.findMany({
    where: {
      org_id: targetOrgId,
      deleted_at: null,
    },
  });

  return NextResponse.json({ data: billingItems });
}
```

---

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### ãƒ†ãƒŠãƒ³ãƒˆé¸æŠã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// next-app/src/components/TenantSelector.tsx

'use client'

import { useState, useEffect } from 'react'
import { Select, Spin } from 'antd'
import { useSession } from '@/hooks/useSession'

interface Tenant {
  id: string
  name: string
  code: string
}

export function TenantSelector() {
  const { user } = useSession()
  const [tenants, setTenants] = useState<Tenant[]>([])
  const [selectedOrgId, setSelectedOrgId] = useState<string>()
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    if (user?.isSystemAdmin) {
      fetchTenants()
    }
  }, [user])

  const fetchTenants = async () => {
    setLoading(true)
    try {
      const response = await fetch('/api/organizations/managed-tenants')
      const data = await response.json()
      setTenants(data.data)
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒï¼‰
      const saved = sessionStorage.getItem('selected_org_id')
      if (saved && data.data.some((t: Tenant) => t.id === saved)) {
        setSelectedOrgId(saved)
      } else if (data.data.length > 0) {
        setSelectedOrgId(data.data[0].id)
      }
    } finally {
      setLoading(false)
    }
  }

  const handleChange = (orgId: string) => {
    setSelectedOrgId(orgId)
    sessionStorage.setItem('selected_org_id', orgId)
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¦ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é€šçŸ¥
    window.dispatchEvent(new CustomEvent('tenant-changed', { detail: { orgId } }))
  }

  if (!user?.isSystemAdmin) {
    return null
  }

  return (
    <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
      <span>ç®¡ç†å¯¾è±¡ãƒ†ãƒŠãƒ³ãƒˆ:</span>
      <Select
        style={{ width: 300 }}
        value={selectedOrgId}
        onChange={handleChange}
        loading={loading}
        options={tenants.map(t => ({
          label: `${t.name} (${t.code})`,
          value: t.id,
        }))}
      />
    </div>
  )
}
```

---

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 1. ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ

```typescript
test('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã§ãƒ­ã‚°ã‚¤ãƒ³ - å…¨ãƒ†ãƒŠãƒ³ãƒˆè¡¨ç¤º', async () => {
  // admin@test.com ã§ãƒ­ã‚°ã‚¤ãƒ³
  await login('admin@test.com', 'password')
  
  // ãƒ†ãƒŠãƒ³ãƒˆé¸æŠUIãŒè¡¨ç¤ºã•ã‚Œã‚‹
  await expect(page.locator('text=ç®¡ç†å¯¾è±¡ãƒ†ãƒŠãƒ³ãƒˆ:')).toBeVisible()
  
  // ãƒ†ãƒŠãƒ³ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  const tenantSelect = page.locator('select')
  await expect(tenantSelect).toContainText('ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“')
  await expect(tenantSelect).toContainText('æ¥½å¸‚æ¥½åº§')
})
```

### 2. ãƒ†ãƒŠãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ

```typescript
test('ãƒ†ãƒŠãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ - ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºç¢ºèª', async () => {
  // admin@test.com ã§ãƒ­ã‚°ã‚¤ãƒ³
  await login('admin@test.com', 'password')
  
  // ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ã‚’é¸æŠ
  await page.selectOption('select', { label: 'ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“æ ªå¼ä¼šç¤¾' })
  
  // ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  await expect(page.locator('text=ã‚¨ã‚³å›åæ±æ—¥æœ¬')).toBeVisible()
  
  // æ¥½å¸‚æ¥½åº§ã‚’é¸æŠ
  await page.selectOption('select', { label: 'æ¥½å¸‚æ¥½åº§æ ªå¼ä¼šç¤¾' })
  
  // æ¥½å¸‚æ¥½åº§ã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  await expect(page.locator('text=ã‚¨ã‚³ã‚¯ãƒªãƒ¼ãƒ³æ±æµ·')).toBeVisible()
})
```

### 3. æ‰‹æ•°æ–™ä»˜åŠ ãƒ†ã‚¹ãƒˆ

```typescript
test('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… - æ‰‹æ•°æ–™ä»˜åŠ ', async () => {
  // admin@test.com ã§ãƒ­ã‚°ã‚¤ãƒ³
  await login('admin@test.com', 'password')
  
  // ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“ã‚’é¸æŠ
  await page.selectOption('select', { label: 'ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“æ ªå¼ä¼šç¤¾' })
  
  // è«‹æ±‚æ˜ç´°ã‚’é¸æŠ
  await page.click('text=è«‹æ±‚æ˜ç´°ã‚’ç¢ºèª')
  
  // æ‰‹æ•°æ–™ã‚’è¿½åŠ 
  await page.click('button:has-text("æ‰‹æ•°æ–™è¿½åŠ ")')
  await page.fill('input[name="fee_amount"]', '5')
  await page.selectOption('select[name="fee_type"]', { label: 'ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸' })
  await page.click('button:has-text("ç¢ºå®š")')
  
  // æ‰‹æ•°æ–™ãŒåæ˜ ã•ã‚Œã‚‹
  await expect(page.locator('text=æ‰‹æ•°æ–™: 5%')).toBeVisible()
})
```

---

## ã¾ã¨ã‚

### è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

1. âœ… **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã®å¾¹åº•**: `org_id` ã«ã‚ˆã‚‹å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿åˆ†é›¢
2. âœ… **æ¨©é™ã®æ˜ç¢ºåŒ–**: `isSystemAdmin` ãƒ•ãƒ©ã‚°ã§ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã‚’è­˜åˆ¥
3. âœ… **æŸ”è»Ÿãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: ãƒ†ãƒŠãƒ³ãƒˆé¸æŠã«ã‚ˆã‚Šã€ç®¡ç†å¯¾è±¡ã‚’åˆ‡ã‚Šæ›¿ãˆ
4. âœ… **æ‹¡å¼µæ€§**: æ–°ã—ã„ãƒ†ãƒŠãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã‚‚è¨­è¨ˆå¤‰æ›´ä¸è¦

### ä»Šå¾Œã®æ‹¡å¼µ

- ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã®æ‰‹æ•°æ–™ç‡è¨­å®š
- ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã®è«‹æ±‚æ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã®ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
- ãƒ†ãƒŠãƒ³ãƒˆé–“ã®ãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒ»æ¯”è¼ƒæ©Ÿèƒ½

---

**ä½œæˆè€…**: AI Assistant  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: æ‰¿èªæ¸ˆã¿  
**é©ç”¨æ—¥**: 2025-10-21



