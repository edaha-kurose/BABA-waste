# æ’å‡ºä¼æ¥­ä»£ç†ç™»éŒ²ãƒ•ãƒ­ãƒ¼è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2025-10-20  
**ç›®çš„**: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ã«ã‚ˆã‚‹æ’å‡ºä¼æ¥­ã®ä»£ç†ç™»éŒ²  
**ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ«æº–æ‹ **: Prismaå¿…é ˆã€SSOTåŸå‰‡ã€RLSå¢ƒç•Œè€ƒæ…®ã€ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ

---

## ğŸ“‹ æ¦‚è¦

### èƒŒæ™¯
æ’å‡ºä¼æ¥­ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆé–‹è¨­ã‚’é¢å€’ã«æ„Ÿã˜ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ãŸã‚ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ãŒä»£ç†ã§ç™»éŒ²ã§ãã‚‹ãƒ•ãƒ­ãƒ¼ã‚’æä¾›ã€‚

### ç›®çš„
1. ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ï¼‰ãŒæ’å‡ºä¼æ¥­ã‚’ä»£ç†ç™»éŒ²
2. ãƒã‚¹ã‚¿ãƒ¼IDï¼ˆåˆæœŸç®¡ç†è€…ï¼‰ã‚’è‡ªå‹•ä½œæˆ
3. æ’å‡ºä¼æ¥­å´ã§è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã‚’ç™»éŒ²å¯èƒ½

### ã‚¹ã‚³ãƒ¼ãƒ—
- **Phase 1**: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ã«ã‚ˆã‚‹ä»£ç†ç™»éŒ²
- **Phase 2**: æ’å‡ºä¼æ¥­å´ã§ã®è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### Phase 1: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ã«ã‚ˆã‚‹ä»£ç†ç™»éŒ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ’å‡ºä¼æ¥­æƒ…å ±å…¥åŠ›ï¼ˆç®¡ç†ç”»é¢ï¼‰                        â”‚
â”‚   - ä¼šç¤¾å                                                  â”‚
â”‚   - çµ„ç¹”ã‚³ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•ç”Ÿæˆ or æ‰‹å‹•å…¥åŠ›ï¼‰                      â”‚
â”‚   - åˆæœŸç®¡ç†è€…æƒ…å ±ï¼ˆæ°åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰                  â”‚
â”‚   - åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•ç”Ÿæˆ or æ‰‹å‹•å…¥åŠ›ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: API Call - POST /api/admin/organizations/register  â”‚
â”‚   Prismaãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³:                                   â”‚
â”‚   1. Supabase Auth ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆauth.usersï¼‰            â”‚
â”‚   2. organizations ä½œæˆ                                     â”‚
â”‚   3. app_users ä½œæˆï¼ˆauth_user_idç´ä»˜ã‘ï¼‰                  â”‚
â”‚   4. user_org_roles ä½œæˆï¼ˆrole='ADMIN'ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ or æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡                    â”‚
â”‚   - Option A: åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç®¡ç†ä¼šç¤¾çµŒç”±ã§é€£çµ¡           â”‚
â”‚   - Option B: Supabase Auth ã®æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ’å‡ºä¼æ¥­ï¼ˆãƒã‚¹ã‚¿ãƒ¼IDã§ãƒ­ã‚°ã‚¤ãƒ³ï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: æ’å‡ºä¼æ¥­å´ã§ã®è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ’å‡ºä¼æ¥­ï¼ˆãƒã‚¹ã‚¿ãƒ¼IDã§ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢ã§è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²                  â”‚
â”‚   - æ°å                                                    â”‚
â”‚   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹                                          â”‚
â”‚   - ãƒ­ãƒ¼ãƒ«ï¼ˆEMITTERã€æ‹…å½“è€…ç­‰ï¼‰                             â”‚
â”‚   - åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•ç”Ÿæˆ or æ‰‹å‹•å…¥åŠ›ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: API Call - POST /api/users/register-member         â”‚
â”‚   Prismaãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³:                                   â”‚
â”‚   1. Supabase Auth ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ                           â”‚
â”‚   2. app_users ä½œæˆ                                         â”‚
â”‚   3. user_org_roles ä½œæˆï¼ˆæ—¢å­˜çµ„ç¹”ã«ç´ä»˜ã‘ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ or åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é€£çµ¡                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«

#### 1. `auth.users` (Supabase Auth)
- Supabase AuthãŒè‡ªå‹•ç®¡ç†
- ä»£ç†ç™»éŒ²æ™‚ã‚‚ Supabase Admin API ã‚’ä½¿ç”¨

#### 2. `app.organizations`
```sql
CREATE TABLE app.organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  code VARCHAR(50) UNIQUE NOT NULL,
  address TEXT,
  phone VARCHAR(50),
  email VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID,  -- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ID
  updated_by UUID,
  deleted_at TIMESTAMPTZ
);
```

#### 3. `app.users` (app_users)
```sql
CREATE TABLE app.users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_user_id UUID UNIQUE NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID,  -- ä»£ç†ç™»éŒ²æ™‚ã¯ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…IDã€è¿½åŠ æ™‚ã¯ãƒã‚¹ã‚¿ãƒ¼ID
  updated_by UUID,
  deleted_at TIMESTAMPTZ
);
```

#### 4. `app.user_org_roles`
```sql
CREATE TABLE app.user_org_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES app.users(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES app.organizations(id) ON DELETE CASCADE,
  role VARCHAR(50) NOT NULL CHECK (role IN ('ADMIN', 'EMITTER', 'TRANSPORTER', 'DISPOSER')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID,
  updated_by UUID,
  deleted_at TIMESTAMPTZ,
  UNIQUE (user_id, org_id)
);
```

---

## ğŸ”§ APIå®Ÿè£…

### Phase 1: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ã«ã‚ˆã‚‹ä»£ç†ç™»éŒ²

#### POST /api/admin/organizations/register

**èªè¨¼**: ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã®ã¿ï¼ˆ`role='SUPER_ADMIN'`ï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```typescript
{
  organization: {
    name: string;        // ä¼šç¤¾å
    code: string;        // çµ„ç¹”ã‚³ãƒ¼ãƒ‰
    address?: string;
    phone?: string;
  };
  master_user: {
    name: string;        // ãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    email: string;       // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    password?: string;   // åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆçœç•¥æ™‚ã¯è‡ªå‹•ç”Ÿæˆï¼‰
    send_email?: boolean; // æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰
  };
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  data: {
    organization: {
      id: string;
      name: string;
      code: string;
    };
    master_user: {
      id: string;
      auth_user_id: string;
      email: string;
      name: string;
      initial_password?: string; // send_email=false ã®å ´åˆã®ã¿
    };
    user_org_role: {
      id: string;
      role: 'ADMIN';
      org_id: string;
    };
  };
  message: 'Organization registered successfully';
}
```

**å®Ÿè£…ä¾‹** (ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ«100%æº–æ‹ ):
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { prisma } from '@/lib/prisma';
import { getAuthenticatedUser } from '@/lib/auth/session-server';
import { createClient } from '@supabase/supabase-js';

const registerSchema = z.object({
  organization: z.object({
    name: z.string().min(1).max(255),
    code: z.string().min(1).max(50),
    address: z.string().optional(),
    phone: z.string().optional(),
  }),
  master_user: z.object({
    name: z.string().min(1).max(255),
    email: z.string().email(),
    password: z.string().min(8).optional(),
    send_email: z.boolean().default(true),
  }),
});

export async function POST(request: NextRequest) {
  try {
    // âœ… èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã®ã¿ï¼‰
    const user = await getAuthenticatedUser(request);
    if (!user || user.role !== 'SUPER_ADMIN') {
      return NextResponse.json(
        { error: 'Forbidden', message: 'Super admin access required' },
        { status: 403 }
      );
    }

    const body = await request.json();
    const validatedData = registerSchema.parse(body);

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const existingOrg = await prisma.organizations.findFirst({
      where: { code: validatedData.organization.code },
    });

    if (existingOrg) {
      return NextResponse.json(
        { error: 'Conflict', message: 'Organization code already exists' },
        { status: 409 }
      );
    }

    const existingUser = await prisma.app_users.findFirst({
      where: { email: validatedData.master_user.email },
    });

    if (existingUser) {
      return NextResponse.json(
        { error: 'Conflict', message: 'Email already exists' },
        { status: 409 }
      );
    }

    // åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆçœç•¥æ™‚ï¼‰
    const initialPassword = validatedData.master_user.password || 
      generateSecurePassword();

    // Supabase Admin ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å°‚ç”¨ï¼‰
    const supabaseAdmin = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!, // ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼
      {
        auth: {
          autoRefreshToken: false,
          persistSession: false,
        },
      }
    );

    // Step 1: Supabase Auth ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email: validatedData.master_user.email,
      password: initialPassword,
      email_confirm: !validatedData.master_user.send_email, // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã—ãªã„å ´åˆã¯è‡ªå‹•ç¢ºèª
      user_metadata: {
        name: validatedData.master_user.name,
        role: 'ADMIN',
      },
    });

    if (authError || !authData.user) {
      throw new Error(`Failed to create auth user: ${authError?.message}`);
    }

    // âœ… Prismaãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ«æº–æ‹ ï¼‰
    const result = await prisma.$transaction(async (tx) => {
      // 2. çµ„ç¹”ä½œæˆ
      const organization = await tx.organizations.create({
        data: {
          name: validatedData.organization.name,
          code: validatedData.organization.code,
          address: validatedData.organization.address,
          phone: validatedData.organization.phone,
          created_by: user.id, // ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã®ID
          updated_by: user.id,
        },
      });

      // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
      const appUser = await tx.app_users.create({
        data: {
          auth_user_id: authData.user.id,
          email: validatedData.master_user.email,
          name: validatedData.master_user.name,
          is_active: true,
          created_by: user.id,
          updated_by: user.id,
        },
      });

      // 4. çµ„ç¹”ãƒ­ãƒ¼ãƒ«ä½œæˆï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¿…ãšADMINï¼‰
      const userOrgRole = await tx.user_org_roles.create({
        data: {
          user_id: appUser.id,
          org_id: organization.id,
          role: 'ADMIN',
          created_by: user.id,
          updated_by: user.id,
        },
      });

      return {
        organization,
        master_user: appUser,
        user_org_role: userOrgRole,
      };
    });

    // æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if (validatedData.master_user.send_email) {
      await supabaseAdmin.auth.admin.inviteUserByEmail(validatedData.master_user.email);
    }

    return NextResponse.json(
      {
        data: {
          ...result,
          master_user: {
            ...result.master_user,
            initial_password: validatedData.master_user.send_email 
              ? undefined 
              : initialPassword, // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã—ãªã„å ´åˆã®ã¿è¿”ã™
          },
        },
        message: 'Organization registered successfully',
      },
      { status: 201 }
    );
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Validation Error', details: error.errors },
        { status: 400 }
      );
    }

    console.error('[Admin Organization Register] Error:', error);
    return NextResponse.json(
      { error: 'Internal Server Error', message: 'Failed to register organization' },
      { status: 500 }
    );
  }
}

// ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆé–¢æ•°
function generateSecurePassword(length: number = 16): string {
  const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let password = '';
  const randomValues = crypto.getRandomValues(new Uint8Array(length));
  for (let i = 0; i < length; i++) {
    password += charset[randomValues[i] % charset.length];
  }
  return password;
}
```

---

### Phase 2: æ’å‡ºä¼æ¥­å´ã§ã®è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

#### POST /api/users/register-member

**èªè¨¼**: åŒçµ„ç¹”ã®ADMINã®ã¿

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```typescript
{
  name: string;
  email: string;
  role: 'EMITTER' | 'TRANSPORTER' | 'DISPOSER';  // ADMINã¯ä¸å¯
  password?: string;      // çœç•¥æ™‚ã¯è‡ªå‹•ç”Ÿæˆ
  send_email?: boolean;   // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  data: {
    user: {
      id: string;
      auth_user_id: string;
      email: string;
      name: string;
      initial_password?: string;
    };
    user_org_role: {
      id: string;
      role: string;
      org_id: string;
    };
  };
  message: 'User registered successfully';
}
```

**å®Ÿè£…ä¾‹** (ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ«100%æº–æ‹ ):
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { prisma } from '@/lib/prisma';
import { getAuthenticatedUser } from '@/lib/auth/session-server';
import { createClient } from '@supabase/supabase-js';

const registerMemberSchema = z.object({
  name: z.string().min(1).max(255),
  email: z.string().email(),
  role: z.enum(['EMITTER', 'TRANSPORTER', 'DISPOSER']), // ADMINã¯é™¤å¤–
  password: z.string().min(8).optional(),
  send_email: z.boolean().default(true),
});

export async function POST(request: NextRequest) {
  try {
    // âœ… èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆåŒçµ„ç¹”ã®ADMINã®ã¿ï¼‰
    const user = await getAuthenticatedUser(request);
    if (!user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    // ADMINãƒ­ãƒ¼ãƒ«ç¢ºèª
    const userRole = await prisma.user_org_roles.findFirst({
      where: {
        user_id: user.id,
        org_id: user.org_id,
        role: 'ADMIN',
        deleted_at: null,
      },
    });

    if (!userRole) {
      return NextResponse.json(
        { error: 'Forbidden', message: 'Admin role required' },
        { status: 403 }
      );
    }

    const body = await request.json();
    const validatedData = registerMemberSchema.parse(body);

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const existingUser = await prisma.app_users.findFirst({
      where: { email: validatedData.email },
    });

    if (existingUser) {
      return NextResponse.json(
        { error: 'Conflict', message: 'Email already exists' },
        { status: 409 }
      );
    }

    // åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
    const initialPassword = validatedData.password || generateSecurePassword();

    // Supabase Admin ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabaseAdmin = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!,
      {
        auth: {
          autoRefreshToken: false,
          persistSession: false,
        },
      }
    );

    // Step 1: Supabase Auth ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email: validatedData.email,
      password: initialPassword,
      email_confirm: !validatedData.send_email,
      user_metadata: {
        name: validatedData.name,
        role: validatedData.role,
      },
    });

    if (authError || !authData.user) {
      throw new Error(`Failed to create auth user: ${authError?.message}`);
    }

    // âœ… Prismaãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    const result = await prisma.$transaction(async (tx) => {
      // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
      const appUser = await tx.app_users.create({
        data: {
          auth_user_id: authData.user.id,
          email: validatedData.email,
          name: validatedData.name,
          is_active: true,
          created_by: user.id, // ãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ID
          updated_by: user.id,
        },
      });

      // 3. çµ„ç¹”ãƒ­ãƒ¼ãƒ«ä½œæˆï¼ˆåŒçµ„ç¹”ã«ç´ä»˜ã‘ï¼‰
      const userOrgRole = await tx.user_org_roles.create({
        data: {
          user_id: appUser.id,
          org_id: user.org_id, // âœ… ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ: åŒçµ„ç¹”ã«ç´ä»˜ã‘
          role: validatedData.role,
          created_by: user.id,
          updated_by: user.id,
        },
      });

      return {
        user: appUser,
        user_org_role: userOrgRole,
      };
    });

    // æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if (validatedData.send_email) {
      await supabaseAdmin.auth.admin.inviteUserByEmail(validatedData.email);
    }

    return NextResponse.json(
      {
        data: {
          ...result,
          user: {
            ...result.user,
            initial_password: validatedData.send_email 
              ? undefined 
              : initialPassword,
          },
        },
        message: 'User registered successfully',
      },
      { status: 201 }
    );
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Validation Error', details: error.errors },
        { status: 400 }
      );
    }

    console.error('[Register Member] Error:', error);
    return NextResponse.json(
      { error: 'Internal Server Error', message: 'Failed to register user' },
      { status: 500 }
    );
  }
}

function generateSecurePassword(length: number = 16): string {
  const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let password = '';
  const randomValues = crypto.getRandomValues(new Uint8Array(length));
  for (let i = 0; i < length; i++) {
    password += charset[randomValues[i] % charset.length];
  }
  return password;
}
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã®æ¨©é™ç®¡ç†

**å•é¡Œ**: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã©ã†ç®¡ç†ã™ã‚‹ï¼Ÿ

**è§£æ±ºç­–**:
- `user_org_roles` ã«ç‰¹åˆ¥ãªçµ„ç¹”IDï¼ˆä¾‹: `SYSTEM_ORG_ID`ï¼‰ã‚’ä½œæˆ
- ãã®çµ„ç¹”ã®ADMINã‚’ã€Œã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã€ã¨ã—ã¦æ‰±ã†

```sql
-- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾çµ„ç¹”ã®ä½œæˆ
INSERT INTO app.organizations (id, name, code)
VALUES ('00000000-0000-0000-0000-000000000001', 'System Admin', 'SYSTEM');

-- ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
INSERT INTO app.user_org_roles (user_id, org_id, role)
VALUES ('your-user-id', '00000000-0000-0000-0000-000000000001', 'ADMIN');
```

### 2. åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å–ã‚Šæ‰±ã„

**Option A: æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ¨å¥¨ï¼‰**
- Supabase Authã®æ‹›å¾…ãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’ä½¿ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š

**Option B: åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€£çµ¡**
- ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆ
- ç®¡ç†ä¼šç¤¾çµŒç”±ã§æ’å‡ºä¼æ¥­ã«é€£çµ¡
- åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚’å¼·åˆ¶

### 3. RLSå¢ƒç•Œã®è€ƒæ…®

**å•é¡Œ**: ä»£ç†ç™»éŒ²æ™‚ã€ã¾ã  `app.current_org_id()` ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:
```typescript
// ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ã‚’è¨­å®š
const result = await prisma.$transaction(async (tx) => {
  const organization = await tx.organizations.create({ ... });

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°è¨­å®šï¼ˆRLSå¯¾å¿œï¼‰
  await tx.$executeRaw`SET app.current_org_id = ${organization.id}`;

  // ä»¥é™ã®æ“ä½œã§RLSãŒé©ç”¨ã•ã‚Œã‚‹
  const user = await tx.app_users.create({ ... });
  const userOrgRole = await tx.user_org_roles.create({ ... });

  return { organization, user, user_org_role: userOrgRole };
});
```

---

## ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### Phase 1: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ã®ç®¡ç†ç”»é¢

#### ç”»é¢: `/admin/organizations/register`

**æ©Ÿèƒ½**:
- æ’å‡ºä¼æ¥­æƒ…å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
- ãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
- åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆ or æ‰‹å‹•å…¥åŠ›
- æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚ªãƒ—ã‚·ãƒ§ãƒ³

**å®Ÿè£…ä¾‹**:
```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

export default function OrganizationRegisterPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    const formData = new FormData(e.currentTarget);
    const data = {
      organization: {
        name: formData.get('org_name') as string,
        code: formData.get('org_code') as string,
        address: formData.get('org_address') as string,
        phone: formData.get('org_phone') as string,
      },
      master_user: {
        name: formData.get('user_name') as string,
        email: formData.get('user_email') as string,
        send_email: formData.get('send_email') === 'on',
      },
    };

    try {
      const response = await fetch('/api/admin/organizations/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to register organization');
      }

      const result = await response.json();

      // åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¿”ã•ã‚ŒãŸå ´åˆï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã—ãªã„å ´åˆï¼‰
      if (result.data.master_user.initial_password) {
        alert(`åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${result.data.master_user.initial_password}\n\nâ€»ã“ã®ç”»é¢ã‚’é–‰ã˜ã‚‹å‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„`);
      }

      router.push('/admin/organizations');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">æ’å‡ºä¼æ¥­ä»£ç†ç™»éŒ²</h1>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
          {error}
        </div>
      )}

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* çµ„ç¹”æƒ…å ± */}
        <section className="border p-4 rounded">
          <h2 className="text-lg font-semibold mb-4">çµ„ç¹”æƒ…å ±</h2>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">
                ä¼šç¤¾å <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="org_name"
                required
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">
                çµ„ç¹”ã‚³ãƒ¼ãƒ‰ <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="org_code"
                required
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">ä½æ‰€</label>
              <input
                type="text"
                name="org_address"
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">é›»è©±ç•ªå·</label>
              <input
                type="tel"
                name="org_phone"
                className="w-full border rounded px-3 py-2"
              />
            </div>
          </div>
        </section>

        {/* ãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */}
        <section className="border p-4 rounded">
          <h2 className="text-lg font-semibold mb-4">ãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">
                æ°å <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="user_name"
                required
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span className="text-red-500">*</span>
              </label>
              <input
                type="email"
                name="user_email"
                required
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div className="flex items-center">
              <input
                type="checkbox"
                name="send_email"
                id="send_email"
                defaultChecked
                className="mr-2"
              />
              <label htmlFor="send_email" className="text-sm">
                æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ï¼ˆãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
              </label>
            </div>
          </div>
        </section>

        <button
          type="submit"
          disabled={loading}
          className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:opacity-50"
        >
          {loading ? 'ç™»éŒ²ä¸­...' : 'ç™»éŒ²ã™ã‚‹'}
        </button>
      </form>
    </div>
  );
}
```

---

### Phase 2: æ’å‡ºä¼æ¥­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢

#### ç”»é¢: `/dashboard/users`

**æ©Ÿèƒ½**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºï¼ˆåŒçµ„ç¹”ã®ã¿ï¼‰
- è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ»å‰Šé™¤

**å®Ÿè£…ä¾‹**:
```typescript
'use client';

import { useState } from 'react';

export default function UsersManagementPage() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleAddUser = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    const formData = new FormData(e.currentTarget);
    const data = {
      name: formData.get('name') as string,
      email: formData.get('email') as string,
      role: formData.get('role') as string,
      send_email: formData.get('send_email') === 'on',
    };

    try {
      const response = await fetch('/api/users/register-member', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to register user');
      }

      const result = await response.json();

      if (result.data.user.initial_password) {
        alert(`åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${result.data.user.initial_password}\n\nâ€»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€£çµ¡ã—ã¦ãã ã•ã„`);
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å†å–å¾—
      window.location.reload();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h1>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
          {error}
        </div>
      )}

      {/* è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  */}
      <section className="border p-4 rounded mb-6">
        <h2 className="text-lg font-semibold mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </h2>
        
        <form onSubmit={handleAddUser} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">
              æ°å <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              name="name"
              required
              className="w-full border rounded px-3 py-2"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span className="text-red-500">*</span>
            </label>
            <input
              type="email"
              name="email"
              required
              className="w-full border rounded px-3 py-2"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">
              ãƒ­ãƒ¼ãƒ« <span className="text-red-500">*</span>
            </label>
            <select
              name="role"
              required
              className="w-full border rounded px-3 py-2"
            >
              <option value="EMITTER">æ’å‡ºæ‹…å½“è€…</option>
              <option value="TRANSPORTER">é‹æ¬æ‹…å½“è€…</option>
              <option value="DISPOSER">å‡¦åˆ†æ‹…å½“è€…</option>
            </select>
          </div>

          <div className="flex items-center">
            <input
              type="checkbox"
              name="send_email"
              id="send_email"
              defaultChecked
              className="mr-2"
            />
            <label htmlFor="send_email" className="text-sm">
              æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
            </label>
          </div>

          <button
            type="submit"
            disabled={loading}
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
          >
            {loading ? 'ç™»éŒ²ä¸­...' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ '}
          </button>
        </form>
      </section>

      {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ */}
      <section>
        <h2 className="text-lg font-semibold mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
        {/* TODO: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å®Ÿè£… */}
      </section>
    </div>
  );
}
```

---

## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ä¼šç¤¾ã«ã‚ˆã‚‹ä»£ç†ç™»éŒ²

#### APIå®Ÿè£…
- [ ] `/api/admin/organizations/register` ä½œæˆ
- [ ] Supabase Admin APIçµ±åˆ
- [ ] Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- [ ] Prismaãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
- [ ] ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…
- [ ] ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆé–¢æ•°ä½œæˆ

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
- [ ] `/admin/organizations/register` ç”»é¢ä½œæˆ
- [ ] ãƒ•ã‚©ãƒ¼ãƒ å®Ÿè£…
- [ ] åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºæ©Ÿèƒ½å®Ÿè£…
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] `SUPABASE_SERVICE_ROLE_KEY` ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³çµ„ç¹”ä½œæˆ
- [ ] ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ

---

### Phase 2: æ’å‡ºä¼æ¥­å´ã§ã®è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

#### APIå®Ÿè£…
- [ ] `/api/users/register-member` ä½œæˆ
- [ ] ADMINæ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…
- [ ] åŒçµ„ç¹”ã¸ã®ç´ä»˜ã‘å®Ÿè£…
- [ ] Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- [ ] Prismaãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
- [ ] `/dashboard/users` ç”»é¢ä½œæˆ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºå®Ÿè£…
- [ ] è¿½åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ å®Ÿè£…
- [ ] ãƒ­ãƒ¼ãƒ«é¸æŠå®Ÿè£…

---

### å“è³ªãƒã‚§ãƒƒã‚¯

- [ ] TypeCheck: `pnpm typecheck`
- [ ] ã‚¹ã‚­ãƒ¼ãƒåŒæœŸç¢ºèª: `pnpm check:schema-sync`
- [ ] å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãƒã‚§ãƒƒã‚¯: `pnpm check:foreign-keys`
- [ ] E2Eãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

---

## ğŸš¨ æ³¨æ„äº‹é …

### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- âœ… **SUPABASE_SERVICE_ROLE_KEY ã¯çµ¶å¯¾ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«éœ²å‡ºã—ãªã„**
- âœ… **åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å®‰å…¨ã«é€£çµ¡**
- âœ… **ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³æ¨©é™ã®å³æ ¼ãªç®¡ç†**

### 2. ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ

- âœ… **RLSãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ç¢ºèª**
- âœ… **org_idåˆ†é›¢ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã‹ç¢ºèª**
- âœ… **ä»£ç†ç™»éŒ²æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°è¨­å®š**

### 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ«æº–æ‹ 

- âœ… **Prismaãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¿…é ˆ**
- âœ… **Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ**
- âœ… **èªè¨¼ãƒã‚§ãƒƒã‚¯å¿…é ˆ**
- âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…**

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ«: `.cursor/rules/global-rules.md`
- Supabase Admin API: https://supabase.com/docs/reference/javascript/admin-api
- Prisma ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³: https://www.prisma.io/docs/concepts/components/prisma-client/transactions

---

**æœ€çµ‚æ›´æ–°**: 2025-10-20  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… è¨­è¨ˆå®Œäº†ï¼ˆå®Ÿè£…å¾…ã¡ï¼‰  
**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: 
1. `SUPABASE_SERVICE_ROLE_KEY` ç’°å¢ƒå¤‰æ•°è¨­å®š
2. ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³çµ„ç¹” + ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
3. Phase 1 APIå®Ÿè£…
4. Phase 1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
5. Phase 2 APIå®Ÿè£…
6. Phase 2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…



