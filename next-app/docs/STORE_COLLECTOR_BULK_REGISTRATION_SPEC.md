# 店舗×収集業者一括登録機能 仕様書

**作成日**: 2025-10-19  
**バージョン**: 1.0  
**ステータス**: 設計中

---

## 📋 概要

### 目的
- 2000件規模の店舗に収集業者を効率的に割り当てる
- 既存の店舗リストをエクスポートし、Excelで編集後、一括インポート
- 店舗ごとに複数の収集業者（優先順位付き）を設定可能

### SSOT準拠
- ✅ 既存スキーマ `store_collector_assignments` を使用
- ✅ Prisma経由でのみDB操作
- ✅ 新規テーブル不要

---

## 🗄️ データモデル

### 使用テーブル

#### 1. `stores` - 店舗マスター
```prisma
model stores {
  id          String   @id
  org_id      String
  store_code  String
  name        String
  area        String?
  // ... その他フィールド
  store_collector_assignments store_collector_assignments[]
}
```

#### 2. `collectors` - 収集業者マスター
```prisma
model collectors {
  id           String   @id
  user_id      String   @unique
  company_name String
  is_active    Boolean  @default(true)
  // ... その他フィールド
}
```

#### 3. `store_collector_assignments` - 店舗×収集業者紐付け
```prisma
model store_collector_assignments {
  id             String    @id
  org_id         String
  store_id       String
  collector_id   String
  priority       Int       @default(1)  // 優先順位
  is_active      Boolean   @default(true)
  effective_from DateTime? // 有効開始日
  effective_to   DateTime? // 有効終了日
  // ... その他フィールド
}
```

---

## 📊 Excel フォーマット

### エクスポート形式

| 列 | 内容 | 必須 | 説明 |
|----|------|------|------|
| A | 店舗コード | ✅ | 一意識別子 |
| B | 店舗名 | ✅ | 表示名 |
| C | エリア | ❌ | 地域情報 |
| D | 収集業者1 | ❌ | 会社名 or ID |
| E | 優先順位1 | ❌ | 1〜99 |
| F | 収集業者2 | ❌ | 会社名 or ID |
| G | 優先順位2 | ❌ | 1〜99 |
| H | 収集業者3 | ❌ | 会社名 or ID |
| I | 優先順位3 | ❌ | 1〜99 |
| J | 有効開始日 | ❌ | YYYY-MM-DD |
| K | 有効終了日 | ❌ | YYYY-MM-DD |
| L | ステータス | ❌ | 現在の割当状況 |

### サンプルデータ
```
店舗コード | 店舗名   | エリア | 収集業者1 | 優先順位1 | 収集業者2 | 優先順位2 | 有効開始日  | 有効終了日 | ステータス
S001       | 新宿店   | 東京   | 業者A     | 1         | 業者B     | 2         | 2025-01-01 |            | 登録済み
S002       | 渋谷店   | 東京   |           |           |           |           |            |            | 未登録
S003       | 池袋店   | 東京   | 業者C     | 1         |           |           | 2025-01-01 |            | 登録済み
```

---

## 🔧 API 仕様

### 1. エクスポートAPI

#### `GET /api/store-collectors/export`

**Query Parameters**:
- `org_id` (required): 組織ID
- `filter`: `all` | `unassigned` | `assigned`
  - `all`: 全店舗（デフォルト）
  - `unassigned`: 収集業者未割当店舗のみ
  - `assigned`: 収集業者割当済み店舗のみ

**Response**:
- `Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- Excelファイルのダウンロード

**処理フロー**:
1. 店舗リストを取得（フィルタ適用）
2. 各店舗の収集業者割当情報を取得
3. Excel生成（`xlsx`ライブラリ使用）
4. ファイルダウンロード

---

### 2. インポートAPI

#### `POST /api/store-collectors/import`

**Request Body**:
```json
{
  "org_id": "uuid",
  "user_id": "uuid",
  "data": [
    {
      "store_code": "S001",
      "collectors": [
        {
          "company_name": "業者A",
          "priority": 1,
          "effective_from": "2025-01-01",
          "effective_to": null
        },
        {
          "company_name": "業者B",
          "priority": 2,
          "effective_from": "2025-01-01",
          "effective_to": null
        }
      ]
    }
  ],
  "mode": "upsert" // "upsert" | "replace"
}
```

**Response**:
```json
{
  "success": true,
  "totalRows": 2000,
  "successRows": 1950,
  "errorRows": 50,
  "errors": [
    "行3: 店舗コード 'S999' が存在しません",
    "行5: 収集業者 '業者X' が見つかりません"
  ],
  "status": "PARTIAL"
}
```

**処理フロー**:
1. バリデーション
   - 店舗存在チェック
   - 収集業者存在チェック
   - 優先順位重複チェック
   - 日付フォーマットチェック
2. トランザクション処理
   - `mode: "replace"` → 既存割当を削除してから登録
   - `mode: "upsert"` → 既存割当を更新 or 追加
3. バッチ処理（50件ずつ）
4. エラーハンドリング

---

## 🎨 UI/UX 設計

### 1. 店舗管理画面の拡張

**場所**: `/dashboard/stores`

**追加ボタン**:
```
┌─────────────────────────────────────────────┐
│ 店舗管理                                    │
├─────────────────────────────────────────────┤
│ [更新] [新規店舗] [収集業者割当↓] [一括登録↑] │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │ 店舗コード │ 店舗名 │ 収集業者 │ 操作 │ │
│ │ S001      │ 新宿店 │ 業者A (1) │ 編集 │ │
│ │ S002      │ 渋谷店 │ 未設定    │ 編集 │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

### 2. エクスポートモーダル

```
┌─────────────────────────────────────────┐
│ 収集業者割当リストをエクスポート        │
├─────────────────────────────────────────┤
│                                         │
│ 対象店舗を選択:                         │
│ ○ 全店舗（2000件）                      │
│ ○ 収集業者未割当のみ（500件）            │
│ ○ 収集業者割当済みのみ（1500件）         │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ℹ️ 注意事項                          │ │
│ │ • エクスポートには約10秒かかります  │ │
│ │ • 各店舗の最大3件の収集業者が出力  │ │
│ │ • Excelで編集後、一括登録できます  │ │
│ └─────────────────────────────────────┘ │
│                                         │
│       [キャンセル]  [エクスポート実行]   │
└─────────────────────────────────────────┘
```

### 3. インポートモーダル

```
┌─────────────────────────────────────────┐
│ 収集業者一括登録                         │
├─────────────────────────────────────────┤
│                                         │
│ Step 1: Excelファイルをアップロード      │
│ ┌─────────────────────────────────────┐ │
│ │ [ファイルを選択]                     │ │
│ │ store_collectors_20250119.xlsx      │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ Step 2: 登録モードを選択                │
│ ○ 追加/更新モード（既存データを保持）   │
│ ○ 置換モード（既存データを削除）        │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ⚠️ 置換モードの注意                  │ │
│ │ • 全ての既存割当が削除されます      │ │
│ │ • Excelに無い店舗は未割当になります │ │
│ └─────────────────────────────────────┘ │
│                                         │
│       [キャンセル]  [列マッピング確認]   │
└─────────────────────────────────────────┘
```

---

## 🔐 バリデーション

### 1. 事前チェック（フロントエンド）
- ✅ ファイル形式（.xlsx, .xls）
- ✅ ファイルサイズ（最大10MB）
- ✅ 必須列の存在

### 2. データバリデーション（バックエンド）
- ✅ 店舗コード存在チェック
  ```sql
  SELECT id FROM stores WHERE org_id = ? AND store_code = ?
  ```
- ✅ 収集業者存在チェック
  ```sql
  SELECT id FROM collectors WHERE org_id = ? AND company_name = ?
  ```
- ✅ 優先順位の重複チェック
  - 同一店舗で同じ優先順位は不可
- ✅ 日付フォーマットチェック
  - `YYYY-MM-DD` 形式
  - `effective_from` ≤ `effective_to`

### 3. ビジネスルール
- ✅ 同一店舗×同一収集業者は1レコードのみ
- ✅ 優先順位は1〜99の範囲
- ✅ is_active = true のレコードのみ有効

---

## 🚀 実装ステップ

### Phase 1: エクスポート機能
1. **API実装**
   - `GET /api/store-collectors/export`
   - Prismaでデータ取得
   - `xlsx`でExcel生成
2. **UI実装**
   - 店舗管理画面にボタン追加
   - エクスポートモーダル
   - フィルタ選択
3. **テスト**
   - 2000件のエクスポート
   - フィルタ動作確認

### Phase 2: インポート機能
1. **API実装**
   - `POST /api/store-collectors/import`
   - Excelパース（`xlsx`）
   - バリデーション
   - バッチ処理（50件ずつ）
2. **UI実装**
   - インポートモーダル
   - 列マッピング画面（既存の `ExcelColumnMapping` 拡張）
   - プログレス表示
3. **テスト**
   - 2000件のインポート
   - エラーハンドリング

### Phase 3: 最適化
1. **パフォーマンス改善**
   - バッチサイズ調整
   - インデックス最適化
2. **UX改善**
   - プログレス表示の精度向上
   - エラーメッセージの詳細化

---

## 📈 パフォーマンス見積もり

### エクスポート
- **データ量**: 2000店舗 × 平均2業者 = 4000レコード
- **処理時間**: 約10秒
- **メモリ使用量**: 約5MB

### インポート
- **データ量**: 2000店舗 × 平均2業者 = 4000レコード
- **バッチサイズ**: 50件
- **バッチ数**: 80バッチ
- **処理時間**: 約60秒（1バッチあたり0.75秒）
- **タイムアウト設定**: 300秒（5分）

---

## 🔒 セキュリティ

### 認証
- ✅ `getAuthenticatedUser` で認証チェック
- ✅ `org_id` は認証ユーザーから取得

### 権限
- ✅ 組織内のデータのみ操作可能
- ✅ RLS（Row Level Security）適用

### バリデーション
- ✅ Zod スキーマでリクエスト検証
- ✅ SQLインジェクション対策（Prisma使用）
- ✅ XSS対策（サニタイズ）

---

## 📝 エラーハンドリング

### ユーザー向けエラーメッセージ

| エラー | メッセージ |
|--------|-----------|
| 店舗不存在 | 「行X: 店舗コード 'SXXX' が存在しません」 |
| 業者不存在 | 「行X: 収集業者 '業者名' が見つかりません」 |
| 優先順位重複 | 「行X: 店舗 'SXXX' の優先順位 '1' が重複しています」 |
| 日付不正 | 「行X: 有効開始日のフォーマットが不正です（YYYY-MM-DD）」 |
| タイムアウト | 「処理がタイムアウトしました。データ量を減らして再試行してください」 |

---

## 🧪 テストシナリオ

### 1. エクスポートテスト
- [ ] 全店舗エクスポート（2000件）
- [ ] 未割当店舗のみエクスポート
- [ ] 割当済み店舗のみエクスポート
- [ ] 出力Excelの内容確認

### 2. インポートテスト
- [ ] 正常系: 2000件の一括登録
- [ ] 異常系: 存在しない店舗コード
- [ ] 異常系: 存在しない収集業者
- [ ] 異常系: 優先順位重複
- [ ] 異常系: 日付フォーマット不正
- [ ] モード: 追加/更新モード
- [ ] モード: 置換モード

### 3. パフォーマンステスト
- [ ] 2000件のエクスポート（10秒以内）
- [ ] 2000件のインポート（60秒以内）
- [ ] 同時実行（複数ユーザー）

---

## 📚 参考資料

### 関連ドキュメント
- `docs/guardrails/SCHEMA_CHANGE_GUIDELINES.md`
- `docs/guardrails/CURSOR_COMMON_SETTINGS_v3.3_BFF.md`
- `.cursor/rules/global-rules.md`

### 既存実装
- `src/app/api/import/waste-requests/route.ts` - 廃棄依頼の一括登録
- `src/components/ExcelColumnMapping.tsx` - 列マッピングコンポーネント

---

**最終更新**: 2025-10-19  
**承認待ち**: ユーザー確認  
**次のアクション**: 実装開始




