# データリセット＆シード完了報告書

**作成日**: 2025-10-20  
**対象組織**: テスト組織A（管理者用）  
**ORG_ID**: `00000000-0000-0000-0000-000000000001`

---

## ✅ 実施内容

### Phase 0: 実装前確認
- ✅ スキーマ同期確認（`pnpm typecheck`）
- ✅ 外部キー制約確認
- ✅ グローバルルール準拠確認

### Step 1: データリセットスクリプト作成
**ファイル**: `prisma/seed-reset-all.ts`

**特徴**:
- 外部キー制約を考慮した削除順序（子→親）
- トランザクション使用
- 組織・ユーザーデータは保持

**実行コマンド**: `pnpm prisma:reset`

### Step 2: 基本データ作成
**使用スクリプト**: `prisma/seed-final.ts`

**作成データ**:
- 収集業者: 1社
- 店舗: 10件
- 品目マスター: 10件
- 収集予定: 240件
- 回収実績: 205件（確定済み）
- 請求サマリー: 12件

**実行コマンド**: `pnpm prisma:seed`

### Step 3: 請求明細生成
**ファイル**: `prisma/seed-billing-from-actuals.ts`

**処理内容**:
1. 単価マスター作成（10件）
2. 回収実績から請求明細生成（10件）
3. 請求サマリー更新

**実行コマンド**: `pnpm prisma:seed:billing-actuals`

---

## 📊 最終データ状態

| データ種別 | 件数 | 状態 |
|-----------|------|------|
| **収集業者** | 1件 | ✅ OK |
| **店舗** | 10件 | ✅ OK |
| **品目マスター** | 10件 | ✅ OK |
| **単価マスター** | 10件 | ✅ OK |
| **収集予定** | 240件 | ✅ OK |
| **回収実績** | 205件（確定済み） | ✅ OK |
| **請求明細** | **10件** | ✅ **新規作成** |
| **請求サマリー** | 13件 | ✅ OK |
| **契約** | 0件 | ⚠️ 未設定（任意） |

---

## 🔍 問題解決

### 元の問題
❌ **請求管理画面で「回収実績データも収集業者も登録されていない」エラー**

### 原因
- 請求明細: 0件 ← **これが原因**
- 単価マスター: 0件
- ダッシュボードとのデータ不整合（org_id分離が不完全）

### 解決策
1. ✅ データリセット（外部キー制約考慮）
2. ✅ 基本データ作成（seed-final.ts）
3. ✅ 単価マスター作成
4. ✅ 請求明細生成（回収実績ベース）

---

## 📝 作成スクリプト

### 1. データリセット
```bash
pnpm prisma:reset
```

### 2. 基本データ作成
```bash
pnpm prisma:seed
```

### 3. 請求明細生成
```bash
pnpm prisma:seed:billing-actuals
```

### 4. データ診断
```bash
node scripts/diagnose-billing-data.mjs
```

---

## 🎯 次のステップ

### 1. ブラウザで確認
```
http://localhost:3001/dashboard/billing
```

**期待される結果**:
- ✅ 収集業者が選択可能
- ✅ 請求明細10件が表示
- ✅ 合計金額: ¥2,228.67

### 2. テストデータの拡充（オプション）
```bash
# より多くの請求明細を生成する場合
pnpm prisma:seed:billing-actuals
```

### 3. E2Eテスト実行（推奨）
```bash
pnpm test:e2e
```

---

## 🛡️ グローバルルール準拠

### A. スキーマ同期
- ✅ `pnpm typecheck` 実行: 0エラー
- ✅ `prisma/schema.prisma` と DB は同期

### B. 外部キー制約
- ✅ 削除順序: 請求明細 → 実績 → 予定 → 店舗・収集業者
- ✅ トランザクション使用

### C. データ整合性
- ✅ org_id で正しく分離
- ✅ deleted_at = null のみ使用
- ✅ 確定済み実績（confirmed_at IS NOT NULL）のみ請求化

### D. SSOT（Single Source of Truth）
- ✅ 統一組織ID使用: `00000000-0000-0000-0000-000000000001`
- ✅ Prismaスキーマに完全準拠

---

## 📚 関連ドキュメント

- グローバルルール: `.cursor/rules/global-rules.md`
- スキーマ変更ガイド: `docs/guardrails/SCHEMA_CHANGE_GUIDELINES.md`
- Prismaマイグレーションガイド: `docs/guardrails/PRISMA_MIGRATION_GUIDE.md`

---

**最終更新**: 2025-10-20  
**ステータス**: ✅ 完了  
**次のアクション**: ブラウザで請求管理画面を確認



