# 店舗×業者登録 実装オプション比較

**作成日**: 2025-10-19  
**バージョン**: 3.0  

---

## 📋 前提条件の修正

### 優先順位の正しい理解
- ❌ **誤**: 優先順位1が自動選択で優先される
- ✅ **正**: よく使う業者順（単なるソート順、リスト表示順）
- **用途**: 画面での表示順、ユーザーが選びやすい順

### 業者マスターの存在
```
collectors テーブル（業者マスター）
  ├─ id: UUID
  ├─ company_name: 会社名
  ├─ contact_person: 担当者
  ├─ phone: 電話番号
  ├─ email: メールアドレス（推定フィールド）
  └─ その他マスター情報
```

---

## 🎯 Option A: 業者マスター先行アプローチ（推奨）

### コンセプト
**「業者マスターありき」の設計**

### フロー
```
Step 1: 業者マスターを先に登録（必須）
  ├─ 手動登録 or
  └─ 業者マスター一括登録（別機能）

Step 2: 店舗×業者紐付け
  ├─ エクスポート: 店舗リスト + 全業者リスト（参照用）
  ├─ 編集: ユーザーが業者IDまたは業者名を入力
  └─ インポート: 業者名 → 業者ID変換 → 紐付け
```

### Excel形式（2シート構成）

#### シート1: 店舗×業者紐付け
| 店舗コード | 店舗名 | 業者コード | 業者名 | 表示順 |
|----------|--------|-----------|--------|--------|
| S001 | 新宿店 | C001 | 業者A | 1 |
| S001 | 新宿店 | C002 | 業者B | 2 |
| S002 | 渋谷店 | C003 | 業者C | 1 |

#### シート2: 業者マスター（参照用、読取専用）
| 業者コード | 業者名 | 電話番号 | 担当者 |
|----------|--------|---------|--------|
| C001 | 業者A | 03-1111-1111 | 田中 |
| C002 | 業者B | 03-2222-2222 | 佐藤 |
| C003 | 業者C | 03-3333-3333 | 鈴木 |

### メリット
- ✅ 業者マスターとの整合性が保証される
- ✅ 業者コードで一意に特定できる
- ✅ 業者情報が一元管理される
- ✅ 後からの修正が容易

### デメリット
- ❌ 事前に業者マスターが必要
- ❌ 2シート構成でやや複雑

---

## 🎯 Option B: 業者マスター自動作成アプローチ

### コンセプト
**「業者マスターも同時に作成」の設計**

### フロー
```
Step 1: 店舗リストをエクスポート

Step 2: ユーザーが業者情報を入力
  | 店舗 | 業者名 | 電話 | メール | 担当者 |
  |------|--------|------|--------|--------|
  | S001 | A社    | 03-1 | a@...  | 田中   |

Step 3: インポート時の処理
  ├─ 業者マスターを検索
  ├─ 存在しない → 新規作成（collectors）
  ├─ 存在する → ID取得
  └─ 店舗×業者を紐付け（store_collector_assignments）
```

### Excel形式（1シート、フル情報）
| 店舗コード | 店舗名 | 業者名 | 業者電話 | 業者メール | 業者担当者 | 表示順 |
|----------|--------|--------|---------|-----------|-----------|--------|
| S001 | 新宿店 | 業者A | 03-1111-1111 | a@test.com | 田中 | 1 |
| S001 | 新宿店 | 業者B | 03-2222-2222 | b@test.com | 佐藤 | 2 |
| S002 | 渋谷店 | 業者C | 03-3333-3333 | c@test.com | 鈴木 | 1 |

### メリット
- ✅ 業者マスター登録と紐付けが同時にできる
- ✅ 1回の操作で完結
- ✅ 新規業者も自動登録される

### デメリット
- ❌ 業者名の表記ゆれでマスターが重複する可能性
- ❌ 業者マスターの一元管理が難しい
- ❌ Excel が横に長くなる

---

## 🎯 Option C: UI主体 + Excel補助アプローチ

### コンセプト
**「画面UIがメイン、Excelは補助」の設計**

### 機能構成

#### 1. 業者マスター管理画面（メイン）
```
[業者管理] 画面
  ├─ 業者一覧
  ├─ 新規登録
  ├─ 一括登録（Excelインポート）
  └─ 一括エクスポート
```

#### 2. 店舗×業者紐付け画面（メイン）
```
[店舗管理] > [業者割当] 画面
  ├─ 店舗選択（ドロップダウン）
  ├─ 業者選択（既存マスターから選択）
  ├─ 追加/削除/並び替え
  └─ 一括設定（複数店舗に同じ業者を割り当て）
```

#### 3. Excel機能（補助）
```
• エクスポート: 現在の設定を確認用にダウンロード
• インポート: 小規模な調整のみ（Option Aと同じ形式）
```

### UI イメージ
```
┌─────────────────────────────────────────┐
│ 店舗: 新宿店 [▼]                        │
├─────────────────────────────────────────┤
│                                         │
│ 担当業者リスト                          │
│ ┌─────────────────────────────────────┐ │
│ │ 1. 業者A [↑↓] [削除]                │ │
│ │ 2. 業者B [↑↓] [削除]                │ │
│ │ 3. 業者C [↑↓] [削除]                │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [業者を追加] ▼                          │
│   業者D                                 │
│   業者E                                 │
│   業者F                                 │
│                                         │
│ [一括設定] この業者リストを他の店舗にも │
│            適用する                     │
│                                         │
└─────────────────────────────────────────┘
```

### メリット
- ✅ 直感的で分かりやすい
- ✅ リアルタイムで結果が見える
- ✅ マスターとの整合性が保証される
- ✅ 段階的に設定できる

### デメリット
- ❌ 2000店舗の一括設定には時間がかかる
- ❌ Excel派のユーザーには不便かも

---

## 🎯 Option D: ハイブリッドアプローチ（最推奨）

### コンセプト
**「Option A + Option C の組み合わせ」**

### 機能分担

#### Phase 1: 業者マスター登録
```
[業者管理] 画面
  ├─ 手動登録（小規模）
  └─ Excel一括登録（大規模）
     └─ 業者名、電話、メール、担当者を一括登録
```

#### Phase 2: 店舗×業者紐付け
```
【小規模（数十店舗）】
→ UI画面で1店舗ずつ設定

【大規模（2000店舗）】
→ Excel一括登録
   ├─ シート1: 店舗×業者（業者コードで指定）
   └─ シート2: 業者マスター（参照用）
```

### 実装優先順位

#### 🔴 Phase 1（即時対応）
1. 業者マスター一括登録機能
   - Excel: 業者名、電話、メール、担当者
   - API: POST /api/collectors/import
2. 店舗×業者紐付けUI（画面）
   - ドロップダウンで業者選択
   - ドラッグ＆ドロップで並び替え

#### 🟡 Phase 2（1週間後）
1. 店舗×業者紐付け一括登録
   - Excel: Option A 形式（2シート）
   - API: POST /api/store-collectors/import

---

## 📊 比較表

| 項目 | Option A | Option B | Option C | Option D |
|------|---------|---------|---------|---------|
| **業者マスター** | 事前登録必須 | 自動作成 | 事前登録必須 | 事前登録必須 |
| **Excel形式** | 2シート | 1シート（横長） | 補助的 | 2シート |
| **データ整合性** | ◎ | △ | ◎ | ◎ |
| **初期セットアップ** | △ | ◎ | △ | ◎ |
| **運用のしやすさ** | ○ | △ | ◎ | ◎ |
| **大規模対応** | ◎ | ◎ | △ | ◎ |
| **複雑度** | 中 | 中 | 低 | 高 |

---

## ✅ 推奨アプローチ

### **Option D（ハイブリッド）を推奨します**

#### 理由
1. **業者マスターの一元管理**
   - 二重登録を防止
   - 情報の整合性を保証

2. **段階的な導入**
   - 小規模: UI画面で直感的に
   - 大規模: Excelで効率的に

3. **柔軟性**
   - 初期は業者マスター登録 + UI設定
   - 運用が安定したらExcel活用

---

## 🚀 実装計画（Option D）

### Step 1: 業者マスター一括登録
```typescript
// API: POST /api/collectors/import
{
  "data": [
    {
      "company_name": "業者A",
      "phone": "03-1111-1111",
      "email": "a@test.com",
      "contact_person": "田中"
    }
  ]
}
```

### Step 2: 店舗×業者紐付けUI
```typescript
// 画面で業者をドラッグ＆ドロップ
// API: POST /api/store-collectors
{
  "store_id": "uuid",
  "collector_id": "uuid",
  "sort_order": 1
}
```

### Step 3: 店舗×業者一括登録
```typescript
// Excel 2シート構成
// API: POST /api/store-collectors/import
{
  "data": [
    {
      "store_code": "S001",
      "collector_code": "C001", // または collector_name
      "sort_order": 1
    }
  ]
}
```

---

**最終更新**: 2025-10-19  
**ステータス**: 提案中  
**次のアクション**: ユーザー確認 → Phase 1から実装開始




