# 本番相当テストデータ作成報告書

**作成日**: 2025-10-20  
**対象組織**: デモ組織 (`12345678-1234-1234-1234-123456789012`)  
**ステータス**: ✅ 実行中

---

## 📋 背景

**問題**:
- ブラウザで「デモ組織」を選択すると、全てのデータが0件と表示
- ログイン中のユーザー (`admin@test.com`) は2つの組織に所属:
  - テスト組織A（管理者用）: **データあり**（請求明細10件）
  - **デモ組織**: **データなし**（0件）

**原因**:
- テストデータは「テスト組織A」にのみ作成されていた
- ブラウザで「デモ組織」を選択していたため、0件と表示された

---

## 🎯 対応方針

**デモ組織（`12345678-1234-1234-1234-123456789012`）に本番相当のテストデータを作成**

| 項目 | 目標件数 | 詳細 |
|-----|---------|------|
| **JWNETコード** | 50件 | JWNET公式の廃棄物コード（全組織共通） |
| **収集業者** | 5件 | 地域別の収集業者 |
| **店舗** | 50件 | 全国の店舗 |
| **廃棄物種別マスター** | 50件 | 収集業者×廃棄物種別 |
| **店舗×品目×業者** | 250件 | 店舗ごとの廃棄物品目 |
| **収集予定** | 4,800件 | 1年分（50店舗×月2回×2品目×12ヶ月） |
| **回収実績** | 4,800件 | 確定済み |
| **請求明細** | **4,800件** | **全実績から生成** |
| **請求サマリー** | 60件 | 月次サマリー（5業者×12ヶ月） |

---

## 🛠️ 実装手順

### Step 1: 不正UUID削除
```bash
pnpm cleanup:invalid-uuids
```
**結果**: ✅ 不正なUUIDは検出されず（正常）

### Step 2: 大量テストデータ作成
```bash
pnpm prisma:seed:production-full
```

**処理内容**:
1. **Phase 0**: JWNETコード作成（トランザクション外、50件）
2. **Phase 1**: 収集業者（5件）、店舗（50件）
3. **Phase 2**: 品目マップ（20件）、廃棄物種別マスター（50件）、店舗×品目×業者（250件）
4. **Phase 3**: 収集予定（4,800件）、回収実績（4,800件）

**処理時間**: 約5分

### Step 3: 請求明細生成
```bash
pnpm prisma:seed:billing-actuals-demo
```

**処理内容**:
- 回収実績から請求明細を生成（4,800件）
- 単価マスターから単価を取得
- 消費税10%を計算
- 請求サマリーを月次集計（60件）

**処理時間**: 約2分

---

## 📊 データ構造

### Phase 1: 初期設定
| データ種別 | 件数 | 詳細 |
|-----------|------|------|
| JWNETコード | 50件 | 燃え殻、汚泥、廃油など20カテゴリ×2-3バリエーション |
| 収集業者 | 5件 | 東日本、西日本、中部、九州、北日本 |
| 店舗 | 50件 | 東京、大阪、愛知、福岡、宮城など10地域×5店舗 |

### Phase 2: マスター設定
| データ種別 | 件数 | 詳細 |
|-----------|------|------|
| 品目マップ | 20件 | 可燃ごみ、廃プラスチック、金属くず、廃油など |
| 廃棄物種別マスター | 50件 | 収集業者（5）×品目（10）、単価50-100円/kg |
| 店舗×品目×業者 | 250件 | 店舗（50）×品目（5） |

### Phase 3: 日常運用（1年分）
| データ種別 | 件数 | 詳細 |
|-----------|------|------|
| 収集予定 | 4,800件 | 50店舗×月2回×2品目×12ヶ月 |
| 回収実績 | 4,800件 | 全予定が確定済み（90-110%の実績） |
| **請求明細** | **4,800件** | **全実績から生成** |
| 請求サマリー | 60件 | 5業者×12ヶ月 |

---

## ✅ 期待される結果

### ブラウザでの確認手順
1. `http://localhost:3001/login` にアクセス
2. `admin@test.com` でログイン
3. **「デモ組織」を選択**
4. 各画面で以下が表示されることを確認:

| 画面 | 期待されるデータ件数 |
|------|-------------------|
| **Phase 1: 初期設定** | |
| ① JWNETコード一括取り込み | 50件登録済み |
| ② 収集業者登録 | 5件登録済み |
| ③ 店舗登録 | 50件登録済み |
| **Phase 2: マスター設定** | |
| ④ 廃棄物種別マスター登録 | 50件登録済み |
| ⑤ 店舗×品目×業者の紐付け | 250件登録済み |
| **Phase 3: 日常運用** | |
| ⑥ 予定取り込み | 4,800件 |
| ⑦ 一斉ヒアリング管理 | 該当データあり |
| ⑧ 回収実績登録 | 4,800件（確定済み） |
| **請求管理** | |
| 請求明細 | **4,800件** |
| 請求サマリー | 60件（月次） |

---

## 🔧 作成スクリプト

### 1. データリセット（オプション）
```bash
pnpm prisma:reset
```

### 2. 本番相当データ作成
```bash
pnpm prisma:seed:production-full
```

### 3. 請求明細生成
```bash
pnpm prisma:seed:billing-actuals-demo
```

### 4. データ診断
```bash
node scripts/check-current-user.mjs
```

---

## 📝 トラブルシューティング

### 問題1: トランザクションタイムアウト
**症状**: "Transaction not found"エラー  
**原因**: JWNETコード200件をトランザクション内で作成  
**対応**: JWNETコードをトランザクション外に移動、件数を50件に削減

### 問題2: 必須フィールド不足
**症状**: "Argument `waste_code` is missing"エラー  
**原因**: `jwnet_waste_codes`テーブルのスキーマ確認不足  
**対応**: スキーマを確認し、全必須フィールドを指定

### 問題3: 0件表示
**症状**: ブラウザで全データが0件と表示  
**原因**: ログイン中のユーザーが別組織（デモ組織）を選択  
**対応**: デモ組織にデータを作成

---

## 🎉 完了確認

**データ作成完了後、以下を確認してください**:

```bash
# 1. ユーザーと組織別データ件数確認
node scripts/check-current-user.mjs

# 2. デモ組織のデータ確認
node scripts/diagnose-billing-data.mjs

# 3. ブラウザで確認
# http://localhost:3001/dashboard
# デモ組織を選択 → 各画面でデータ表示を確認
```

**期待される出力**:
```
【組織別データ件数】

■ デモ組織 (null)
  org_id: 12345678-1234-1234-1234-123456789012
  - 収集業者: 5件
  - 店舗: 50件
  - 品目マップ: 20件
  - 単価マスター: 50件
  - 収集予定: 4,800件
  - 回収実績: 4,800件
  - 請求明細: 4,800件
```

---

**最終更新**: 2025-10-20  
**ステータス**: ✅ 実行中  
**次のアクション**: 
1. スクリプト完了を待つ（約5分）
2. 請求明細を生成（約2分）
3. ブラウザで確認



