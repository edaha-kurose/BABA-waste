# 店舗×収集業者一括登録機能 仕様書 v2

**作成日**: 2025-10-19  
**バージョン**: 2.0  
**ステータス**: 設計中（修正版）

---

## 📋 概要

### 改善内容（v1 → v2）
- ❌ v1の問題: 横展開で最大3社 → 10社に対応できない
- ✅ v2の解決: **縦並び**で1行＝1つの紐付け → 無制限に対応
- ✅ **2段階アプローチ**:
  1. **基本設定**: 店舗×業者（優先順位付き）
  2. **詳細設定**: 品目×業者（品目単位で指定）

### SSOT準拠（既存スキーマ100%活用）
```
【基本設定】
store_collector_assignments
  └─ 店舗 × 業者（優先順位）

【詳細設定】
store_items
  └─ 店舗 × 品目 × 業者
```

---

## 🎯 機能概要

### Phase 1: 基本設定（店舗×業者）

**目的**: 各店舗に対応可能な業者を登録（優先順位付き）

**Excel形式（縦並び）**:
```
店舗コード | 店舗名 | 収集業者 | 優先順位 | 有効開始日 | 有効終了日
S001       | 新宿店 | 業者A     | 1        | 2025-01-01 | 
S001       | 新宿店 | 業者B     | 2        | 2025-01-01 | 
S001       | 新宿店 | 業者C     | 3        | 2025-01-01 | 
S002       | 渋谷店 | 業者D     | 1        | 2025-01-01 | 
```

**データ量**:
- 2000店舗 × 平均3業者 = 6000行
- 処理時間: 約60秒

**登録先テーブル**: `store_collector_assignments`

---

### Phase 2: 詳細設定（品目×業者）

**目的**: 品目ごとに業者を指定（より細かい制御）

**Excel形式**:
```
店舗コード | 店舗名 | 品目名     | 品目コード | 収集業者 | 並び順
S001       | 新宿店 | 一般ごみ   | G001       | 業者A     | 1
S001       | 新宿店 | 産業廃棄物 | S001       | 業者B     | 2
S001       | 新宿店 | 資源ごみ   | R001       | 業者A     | 3
S002       | 渋谷店 | 一般ごみ   | G001       | 業者D     | 1
```

**データ量**:
- 2000店舗 × 平均5品目 = 10000行
- 処理時間: 約90秒

**登録先テーブル**: `store_items`

---

## 🗄️ データモデル

### 1. store_collector_assignments（基本設定）

```prisma
model store_collector_assignments {
  id             String    @id
  org_id         String
  store_id       String
  collector_id   String
  priority       Int       // 優先順位（1〜99）
  is_active      Boolean   @default(true)
  effective_from DateTime?
  effective_to   DateTime?
  // ...
}
```

**ユースケース**:
- 店舗に対応可能な業者を登録
- 優先順位で選定
- 品目指定がない場合のデフォルト業者

---

### 2. store_items（詳細設定）

```prisma
model store_items {
  id                    String   @id
  org_id                String
  store_id              String
  item_name             String   // 品目名
  item_code             String?  // 品目コード
  assigned_collector_id String?  // 担当業者
  sort_order            Int      // 表示順
  is_active             Boolean  @default(true)
  // ...
}
```

**ユースケース**:
- 品目ごとに業者を指定
- より細かい制御が必要な場合
- 基本設定より優先される

---

## 📊 データフロー

### 初期セットアップ

```
Step 1: 店舗マスター登録（2000件）
  ↓
Step 2: 業者マスター登録
  ↓
Step 3: 基本設定（必須）
  Excel → store_collector_assignments
  ┌─────────────────────────────┐
  │ 店舗コード | 業者 | 優先順位 │
  │ S001      | A社  | 1       │
  │ S001      | B社  | 2       │
  └─────────────────────────────┘
  ↓
Step 4: 詳細設定（オプション）
  Excel → store_items
  ┌──────────────────────────────┐
  │ 店舗コード | 品目   | 業者  │
  │ S001      | 一般   | A社   │
  │ S001      | 産廃   | B社   │
  └──────────────────────────────┘
```

### 運用時の業者選定ロジック

```typescript
// 廃棄依頼発生時
function selectCollector(storeId: string, itemName: string) {
  // 1. 品目専用業者を検索（詳細設定）
  const storeItem = await prisma.store_items.findFirst({
    where: {
      store_id: storeId,
      item_name: itemName,
      is_active: true,
      assigned_collector_id: { not: null }
    }
  })
  
  if (storeItem?.assigned_collector_id) {
    return storeItem.assigned_collector_id // 詳細設定が優先
  }
  
  // 2. 店舗のデフォルト業者を検索（基本設定）
  const assignment = await prisma.store_collector_assignments.findFirst({
    where: {
      store_id: storeId,
      is_active: true
    },
    orderBy: { priority: 'asc' } // 優先順位1の業者
  })
  
  return assignment?.collector_id
}
```

---

## 🎨 UI/UX 設計

### 店舗管理画面の拡張

```
┌────────────────────────────────────────┐
│ 店舗管理                               │
├────────────────────────────────────────┤
│                                        │
│ [更新] [新規店舗]                      │
│                                        │
│ ▼ 収集業者の一括登録                  │
│   ├─ [基本設定] 店舗単位で業者を登録  │
│   │   • 優先順位付き（最大10社）      │
│   │   • まずはここから                │
│   │                                    │
│   └─ [詳細設定] 品目単位で業者を指定  │
│       • より細かい制御                 │
│       • 必要に応じて設定               │
│                                        │
└────────────────────────────────────────┘
```

---

### 1. 基本設定画面

```
┌─────────────────────────────────────────┐
│ 収集業者 基本設定（店舗単位）           │
├─────────────────────────────────────────┤
│                                         │
│ 目的: 各店舗に対応可能な業者を登録      │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ℹ️ 設定のポイント                   │ │
│ │ • 優先順位1の業者が最優先で選ばれる │ │
│ │ • 詳細設定がない場合のデフォルト    │ │
│ │ • 1店舗に最大10社まで登録可能       │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 対象店舗:                               │
│ ○ 全店舗（2000件）                      │
│ ○ 未設定の店舗のみ（500件）             │
│                                         │
│ [エクスポート]  [一括登録]              │
│                                         │
└─────────────────────────────────────────┘
```

**エクスポート Excel**:
| 店舗コード | 店舗名 | 収集業者 | 優先順位 | 有効開始日 | 有効終了日 | ステータス |
|----------|--------|----------|---------|-----------|-----------|-----------|
| S001 | 新宿店 | 業者A | 1 | 2025-01-01 | | 登録済み |
| S001 | 新宿店 | 業者B | 2 | 2025-01-01 | | 登録済み |
| S002 | 渋谷店 | | | | | 未設定 |

---

### 2. 詳細設定画面

```
┌─────────────────────────────────────────┐
│ 収集業者 詳細設定（品目単位）           │
├─────────────────────────────────────────┤
│                                         │
│ 目的: 品目ごとに業者を指定              │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ℹ️ 設定のポイント                   │ │
│ │ • 基本設定より優先されます          │ │
│ │ • 品目ごとに異なる業者を指定可能    │ │
│ │ • 設定しない品目は基本設定を使用    │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 対象店舗:                               │
│ ○ 全店舗（2000件）                      │
│ ○ 基本設定済みの店舗のみ（1500件）      │
│                                         │
│ [エクスポート]  [一括登録]              │
│                                         │
└─────────────────────────────────────────┘
```

**エクスポート Excel**:
| 店舗コード | 店舗名 | 品目名 | 品目コード | 収集業者 | 並び順 | ステータス |
|----------|--------|--------|-----------|----------|--------|-----------|
| S001 | 新宿店 | 一般ごみ | G001 | 業者A | 1 | 登録済み |
| S001 | 新宿店 | 産業廃棄物 | S001 | 業者B | 2 | 登録済み |
| S001 | 新宿店 | 資源ごみ | R001 | | 3 | 未設定 |

---

## 🔧 API 仕様

### 基本設定API

#### 1. `GET /api/store-collectors/export`

**Query Parameters**:
- `org_id`: 組織ID
- `filter`: `all` | `unassigned`

**Response**: Excelファイル

---

#### 2. `POST /api/store-collectors/import`

**Request Body**:
```json
{
  "org_id": "uuid",
  "user_id": "uuid",
  "data": [
    {
      "store_code": "S001",
      "collector_name": "業者A",
      "priority": 1,
      "effective_from": "2025-01-01",
      "effective_to": null
    }
  ],
  "mode": "upsert" // or "replace"
}
```

**処理フロー**:
1. バリデーション
2. バッチ処理（50件ずつ）
3. `store_collector_assignments` に登録

---

### 詳細設定API

#### 3. `GET /api/store-items/export`

**Query Parameters**:
- `org_id`: 組織ID
- `filter`: `all` | `assigned`

**Response**: Excelファイル

---

#### 4. `POST /api/store-items/import`

**Request Body**:
```json
{
  "org_id": "uuid",
  "user_id": "uuid",
  "data": [
    {
      "store_code": "S001",
      "item_name": "一般ごみ",
      "item_code": "G001",
      "collector_name": "業者A",
      "sort_order": 1
    }
  ]
}
```

**処理フロー**:
1. バリデーション
2. バッチ処理（50件ずつ）
3. `store_items` を upsert

---

## 📈 パフォーマンス

### 基本設定
- データ量: 2000店舗 × 3業者 = 6000行
- バッチサイズ: 50件
- 処理時間: 約60秒

### 詳細設定
- データ量: 2000店舗 × 5品目 = 10000行
- バッチサイズ: 50件
- 処理時間: 約90秒

---

## 🚀 実装ステップ

### Phase 1: 基本設定（優先）
1. エクスポートAPI実装
2. インポートAPI実装
3. UI実装
4. テスト（2000件）

### Phase 2: 詳細設定
1. エクスポートAPI実装
2. インポートAPI実装
3. UI実装
4. テスト（10000件）

---

## 💡 推奨運用フロー

### 初期セットアップ
```
1. 基本設定から開始
   → 全店舗に業者を割り当て（優先順位付き）
   ↓
2. 詳細設定は必要に応じて
   → 特定の品目だけ別業者を指定
```

### メリット
- ✅ シンプルに開始できる
- ✅ 段階的に詳細化できる
- ✅ 柔軟性が高い

---

**最終更新**: 2025-10-19  
**バージョン**: 2.0  
**ステータス**: 承認待ち




