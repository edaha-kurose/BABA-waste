# メニュー統合提案

**作成日**: 2025-10-19  
**目的**: 画面数を削減し、ワークフローベースのUI設計に移行  
**原則**: グローバルルール準拠（SSOT、DRY、ワークフロー重視）

---

## 🎯 統合方針

### 原則
1. **SSOT（Single Source of Truth）**: 同じデータは1箇所で管理
2. **ワークフローベース**: 業務フローに沿った画面構成
3. **マスター統合**: 関連するマスターは1画面で管理
4. **CRUD統合**: 一覧・登録・編集を1画面に統合

---

## 🔍 現状分析

### 現在のメニュー構造（20画面）

```
📖 システムガイド
├─ 廃棄物管理（4画面）
│   ├─ 廃棄依頼一覧
│   ├─ 予定管理
│   ├─ 回収情報登録
│   └─ 回収実績データ
├─ 請求管理（1画面）
├─ レポート・分析（2画面）
│   ├─ 回収レポート
│   └─ 統計レポート
├─ JWNET連携（3画面）
│   ├─ JWNET管理
│   ├─ JWNET登録データ
│   └─ 仮登録管理
├─ 店舗・業者管理（5画面）
│   ├─ 店舗管理
│   ├─ 店舗品目業者マトリクス
│   ├─ 外部店舗管理
│   ├─ 収集業者管理
│   └─ 一斉ヒアリング管理
└─ システム管理（5画面）
    ├─ 組織管理
    ├─ ユーザー管理
    ├─ マスター管理
    │   ├─ 品目マップ
    │   ├─ 廃棄物コードマスター
    │   └─ 事業者組み合わせ
    ├─ 取り込み履歴
    └─ 設定
```

---

## ✅ 統合提案

### 提案1: 廃棄物マスター統合 🔥 **優先度：高**

#### 統合対象
- ❌ 削除: `品目マップ`（item_maps）
- ❌ 削除: `廃棄物コードマスター`（JWNET廃棄物コードマスター）
- ✅ 統合先: `廃棄物マスター管理`（waste_type_masters）

#### 理由
```
品目マップ:
  - 社内品目名 → JWNET廃棄物コード のマッピング
  - 用途: 廃棄物種別マスターと完全に重複

廃棄物コードマスター:
  - JWNETコードの参照用マスター
  - 用途: 廃棄物種別マスター登録時に選択するだけ

廃棄物種別マスター:
  - 業者ごとの取り扱い廃棄物
  - すでにJWNETコード選択機能を実装済み
  - 品目マップの機能も包含可能
```

#### 実装案

**新画面: 廃棄物マスター統合管理**

```
廃棄物マスター統合管理
├─ タブ1: JWNETコードマスター（参照用）
│   ├─ 🔄 JWNET公式コードを一括取り込み
│   └─ 検索・閲覧（編集不可）
│
├─ タブ2: 廃棄物種別マスター（業者別管理）
│   ├─ 業者選択
│   ├─ 廃棄物種別の登録・編集・削除
│   └─ JWNETコードから選択（タブ1と連携）
│
└─ タブ3: 品目マップ（社内品目管理）
    ├─ 社内品目名の管理
    └─ JWNETコードへのマッピング
```

**削減効果**: 3画面 → 1画面（▲2画面）

---

### 提案2: 店舗管理統合 🔥 **優先度：高**

#### 統合対象
- ❌ 削除: `外部店舗管理`（hearing_external_stores）
- ✅ 統合先: `店舗管理`（stores）

#### 理由
```
外部店舗管理:
  - 一斉ヒアリング用の外部店舗
  - 用途: 一斉ヒアリング管理画面で直接管理可能

店舗管理:
  - 自社管理店舗のマスター
  - フラグ追加で外部店舗も管理可能
```

#### 実装案

**拡張: 店舗管理**

```
店舗管理
├─ フィルター追加
│   ├─ 自社店舗（is_external = false）
│   └─ 外部店舗（is_external = true）
│
└─ 店舗登録
    ├─ 店舗区分選択（自社/外部）
    └─ 外部店舗の場合は収集業者を紐付け
```

**削減効果**: 2画面 → 1画面（▲1画面）

---

### 提案3: JWNET管理統合 💡 **優先度：中**

#### 統合対象
- ❌ 削除: `JWNET登録データ`（jwnet_registrations）
- ❌ 削除: `仮登録管理`（jwnet_reservations）
- ✅ 統合先: `JWNET管理`

#### 理由
```
JWNET管理:
  - 電子マニフェストの送受信
  
JWNET登録データ:
  - マニフェスト登録済みデータの閲覧
  - 用途: JWNET管理のタブで表示可能

仮登録管理:
  - マニフェスト仮登録データの管理
  - 用途: JWNET管理のワークフローに統合
```

#### 実装案

**拡張: JWNET管理（ワークフローベース）**

```
JWNET管理
├─ タブ1: 予約データ（仮登録）
│   ├─ ステータス: 未送信/送信済み/エラー
│   └─ アクション: 送信/編集/削除
│
├─ タブ2: 登録データ（本登録）
│   ├─ ステータス: 登録済み/確認済み
│   └─ アクション: 確認/修正/削除
│
└─ タブ3: 送受信履歴
    └─ API通信ログ
```

**削減効果**: 3画面 → 1画面（▲2画面）

---

### 提案4: レポート統合 💡 **優先度：中**

#### 統合対象
- ❌ 削除: `統計レポート`
- ✅ 統合先: `回収レポート`

#### 理由
```
回収レポート:
  - 回収実績のレポート

統計レポート:
  - 集計データの可視化
  - 用途: 回収レポートのタブで表示可能
```

#### 実装案

**拡張: レポート**

```
レポート
├─ タブ1: 回収実績レポート
│   ├─ 期間指定
│   ├─ 店舗別/業者別/品目別
│   └─ Excel出力
│
├─ タブ2: 統計ダッシュボード
│   ├─ グラフ・チャート
│   └─ トレンド分析
│
└─ タブ3: 請求レポート
    └─ 請求明細の集計
```

**削減効果**: 2画面 → 1画面（▲1画面）

---

### 提案5: 予定・実績統合 ⚠️ **優先度：低（要検討）**

#### 統合対象
- ❌ 削除: `予定管理`
- ❌ 削除: `回収実績データ`
- ✅ 統合先: `廃棄依頼一覧`（ワークフローベース）

#### 理由
```
廃棄依頼一覧:
  - 廃棄物の排出予定

予定管理:
  - 回収予定の管理
  - 用途: 廃棄依頼とほぼ同じ

回収実績データ:
  - 回収完了データ
  - 用途: 廃棄依頼のステータス遷移で管理可能
```

#### 実装案（慎重に検討）

**拡張: 廃棄物管理（ワークフローベース）**

```
廃棄物管理
├─ フィルター: ステータス選択
│   ├─ 依頼済み（予定）
│   ├─ 回収中
│   └─ 完了（実績）
│
├─ 一覧表示
│   └─ ステータスごとに色分け
│
└─ アクション
    ├─ 依頼登録（Excel取り込み）
    ├─ 回収情報登録
    └─ 実績確認
```

**削減効果**: 3画面 → 1画面（▲2画面）

**⚠️ 注意**: ワークフローが複雑になる可能性あり

---

## 📊 統合効果まとめ

| 提案 | 対象 | 削減数 | 優先度 |
|------|------|--------|--------|
| 1. 廃棄物マスター統合 | 品目マップ、廃棄物コードマスター | ▲2画面 | 🔥 高 |
| 2. 店舗管理統合 | 外部店舗管理 | ▲1画面 | 🔥 高 |
| 3. JWNET管理統合 | 登録データ、仮登録管理 | ▲2画面 | 💡 中 |
| 4. レポート統合 | 統計レポート | ▲1画面 | 💡 中 |
| 5. 予定・実績統合 | 予定管理、回収実績データ | ▲2画面 | ⚠️ 低 |

**合計削減**: 20画面 → 12画面（▲8画面、60%に削減）

---

## 🎯 推奨実装順序

### Phase 1: 最優先（即時実施）

1. **廃棄物マスター統合**
   - 理由: 機能が完全に重複している
   - 作業量: 中
   - 効果: ▲2画面

2. **店舗管理統合**
   - 理由: フラグ追加のみで実現可能
   - 作業量: 小
   - 効果: ▲1画面

### Phase 2: 優先（1週間以内）

3. **JWNET管理統合**
   - 理由: ワークフローを明確化
   - 作業量: 大
   - 効果: ▲2画面

4. **レポート統合**
   - 理由: ユーザー体験向上
   - 作業量: 小
   - 効果: ▲1画面

### Phase 3: 検討（要ユーザーフィードバック）

5. **予定・実績統合**
   - 理由: ワークフローが複雑になる可能性
   - 作業量: 大
   - 効果: ▲2画面

---

## 🔧 実装ガイドライン（グローバルルール準拠）

### 1. データベース設計

```sql
-- ✅ 正しいアプローチ
-- 既存テーブルにフラグ追加

ALTER TABLE app.stores
ADD COLUMN IF NOT EXISTS is_external BOOLEAN DEFAULT false;

COMMENT ON COLUMN app.stores.is_external IS '外部店舗フラグ（一斉ヒアリング用）';

-- インデックス追加
CREATE INDEX IF NOT EXISTS idx_stores_is_external ON app.stores(is_external);
```

### 2. Prisma Schema更新

```prisma
// ✅ Prisma経由での変更
model stores {
  id          String  @id
  is_external Boolean @default(false) // 外部店舗フラグ
  // ...
}
```

### 3. API設計

```typescript
// ✅ 1つのAPIで複数の用途を扱う

// GET /api/stores?is_external=true  ← 外部店舗のみ
// GET /api/stores?is_external=false ← 自社店舗のみ
// GET /api/stores                   ← 全店舗

export async function GET(request: NextRequest) {
  const authUser = await getAuthenticatedUser(request);
  const { searchParams } = new URL(request.url);
  const is_external = searchParams.get('is_external');

  const where: any = { org_id: authUser.org_id };
  if (is_external !== null) {
    where.is_external = is_external === 'true';
  }

  const stores = await prisma.stores.findMany({ where });
  return NextResponse.json({ data: stores });
}
```

### 4. UI設計

```typescript
// ✅ タブ形式で統合

<Tabs>
  <TabPane tab="自社店舗" key="internal">
    <StoreList isExternal={false} />
  </TabPane>
  <TabPane tab="外部店舗" key="external">
    <StoreList isExternal={true} />
  </TabPane>
</Tabs>
```

---

## 📝 削除対象画面の移行計画

### 削除画面とデータ移行

| 削除画面 | テーブル | 移行先 | データ移行 |
|---------|---------|--------|-----------|
| 品目マップ | item_maps | 廃棄物マスター統合 | データ保持、UI統合 |
| 廃棄物コードマスター | jwnet_waste_codes | 廃棄物マスター統合 | データ保持、タブ化 |
| 外部店舗管理 | stores | 店舗管理 | is_external=true |
| JWNET登録データ | jwnet_registrations | JWNET管理 | タブ化 |
| 仮登録管理 | jwnet_reservations | JWNET管理 | タブ化 |
| 統計レポート | - | レポート | タブ化 |

---

## 🎓 まとめ

### 統合の利点

1. **ユーザー体験向上**
   - 画面遷移の削減
   - ワークフローの明確化
   - 関連データの一元表示

2. **メンテナンス性向上**
   - コードの重複削減
   - SSOT原則の徹底
   - バグ修正の容易化

3. **開発効率向上**
   - 新機能追加の高速化
   - テストの簡素化

### 注意事項

- ⚠️ **段階的に実施**: 一度に全てを統合しない
- ⚠️ **ユーザーフィードバック**: 統合後の使い勝手を確認
- ⚠️ **ロールバック可能**: 旧画面を残しておく

---

**最終更新**: 2025-10-19  
**ステータス**: ✅ レビュー待ち  
**次のアクション**: Phase 1の承認 → 実装開始




