# 請求テストデータパターン網羅ガイド

**作成日**: 2025-10-20  
**目的**: 多様な請求パターンのテストデータを網羅的に提供

---

## 📊 作成済みデータサマリー

### 総数
- **請求明細**: 18件
- **総請求額**: 400,916円（税込）

### 請求タイプ別内訳

| タイプ | 件数 | 合計金額 | 平均金額 | 説明 |
|--------|------|----------|----------|------|
| **月額固定** | 4件 | 209,000円 | 52,250円 | 定額サービス料金（数量なし） |
| **実績数量** | 6件 | 123,607円 | 20,601円 | 廃棄物排出量×単価 |
| **その他** | 6件 | 68,200円 | 11,367円 | 特別料金、調整費用 |
| **標準** | 2件 | 109円 | 55円 | 従来のテストデータ |

### ステータス別内訳

| ステータス | 件数 | 合計金額 |
|------------|------|----------|
| **APPROVED** | 12件 | 332,607円 |
| **DRAFT** | 6件 | 68,309円 |

---

## 🎯 テストカバレッジ

### ✅ 完全カバー済み

- [x] **月額固定料金** - 定額サービス（数量・単価なし）
- [x] **実績数量ベース** - 従量課金（数量×単価）
- [x] **その他（特別料金）** - イレギュラーな請求項目
- [x] **下書きステータス** - 未承認の請求
- [x] **承認済みステータス** - 確定した請求
- [x] **マイナス金額（返金）** - 過払い返金・調整

---

## 📋 パターン詳細

### パターン1: 月額固定（monthly_fixed）

**特徴**:
- 店舗ごとの定額サービス料金
- `quantity`, `unit`, `unit_price` は `null`
- 金額は固定

**サンプル**:
```json
{
  "billing_type": "monthly_fixed",
  "item_name": "廃棄物管理サービス月額利用料",
  "item_code": "SVC-MONTHLY-001",
  "amount": 50000,
  "quantity": null,
  "unit": null,
  "unit_price": null,
  "total_amount": 55000,
  "notes": "月額固定料金（廃棄物管理サポート含む）"
}
```

**テストシナリオ**:
- [ ] 月額固定料金の請求書発行
- [ ] 定額サービスの解約処理
- [ ] 年間契約の一括請求
- [ ] 複数店舗への一括請求

---

### パターン2: 実績数量ベース（actual_quantity）

**特徴**:
- 廃棄物の実際の排出量に基づく従量課金
- `quantity`, `unit`, `unit_price` が全て存在
- `amount = quantity × unit_price`

**サンプル**:
```json
{
  "billing_type": "actual_quantity",
  "item_name": "混合廃棄物 収集運搬",
  "item_code": "WASTE-W19",
  "waste_type_id": "xxx-xxx-xxx",
  "quantity": 3.5,
  "unit": "TON",
  "unit_price": 22000,
  "amount": 77000,
  "total_amount": 84700,
  "notes": "実績数量に基づく請求"
}
```

**テストシナリオ**:
- [ ] 実績数量の変動による請求額変更
- [ ] 数量0の場合のハンドリング
- [ ] 単価変更の履歴管理
- [ ] 数量の小数点処理（0.5トン等）
- [ ] 異なる単位（TON、KG、L、PCS）の処理

---

### パターン3: その他（other）

**特徴**:
- 特別料金、調整費用、追加サービス
- 柔軟な請求項目
- マイナス金額（返金）も可能

**サンプル**:
```json
{
  "billing_type": "other",
  "item_name": "緊急回収サービス",
  "item_code": "SVC-EMERGENCY",
  "amount": 30000,
  "total_amount": 33000,
  "notes": "休日緊急対応"
}
```

```json
{
  "billing_type": "other",
  "item_name": "前月過不足調整",
  "item_code": "ADJ-PREV-MONTH",
  "amount": -8000,
  "total_amount": -8800,
  "notes": "9月分請求過剰による返金"
}
```

**テストシナリオ**:
- [ ] 緊急回収料金の追加請求
- [ ] マニフェスト電子化手数料
- [ ] 特別管理産業廃棄物の加算料金
- [ ] 過払い返金処理（マイナス金額）
- [ ] 運搬距離による追加料金
- [ ] 容器レンタル料

---

### パターン4: 複合パターン（1店舗に複数明細）

**特徴**:
- 1つの店舗に対して複数の請求タイプが混在
- 実際の業務フローに近い

**サンプル**:
```
店舗ID: xxx-xxx-xxx
├── 月額固定: 基本サービス料 40,000円
├── 実績数量: 混合廃棄物 3.5トン @ 22,000円/トン = 77,000円
└── その他: 容器レンタル料 8,000円
合計: 125,000円（税抜）
```

**テストシナリオ**:
- [ ] 複数明細の合算請求書発行
- [ ] 店舗別の請求内訳表示
- [ ] 請求タイプ別の集計レポート
- [ ] 一部明細の承認・差し戻し

---

## 🚀 テストデータ再生成方法

### 基本テストデータ作成
```bash
cd next-app
pnpm prisma:seed          # 基本データ（店舗、収集業者、実績等）
pnpm prisma:seed:complete # マスターデータ（廃棄物種別、契約）
```

### 請求パターン網羅データ追加
```bash
pnpm prisma:seed:billing  # 多様な請求パターンのテストデータ
```

### データ確認
```bash
node scripts/check-test-data.mjs        # 基本確認
node scripts/check-billing-patterns.mjs # 請求パターン詳細確認
```

---

## 🧪 推奨テストシナリオ

### 基本機能テスト
1. **請求書一覧表示**
   - [ ] 全ての請求タイプが表示される
   - [ ] 金額が正しく表示される
   - [ ] ステータス別フィルタが動作する

2. **請求書詳細表示**
   - [ ] 月額固定: 数量欄が非表示
   - [ ] 実績数量: 数量・単価・金額が連動
   - [ ] その他: マイナス金額が赤字表示

3. **請求書編集**
   - [ ] DRAFT→APPROVED への変更
   - [ ] 実績数量の変更で金額が自動計算
   - [ ] マイナス金額の入力制限

### エッジケーステスト
1. **数値境界値**
   - [ ] 数量0の処理
   - [ ] 極小値（0.001トン）
   - [ ] 極大値（999.999トン）
   - [ ] マイナス金額（返金）

2. **データ整合性**
   - [ ] waste_type_id が null の場合
   - [ ] 削除された廃棄物種別への参照
   - [ ] 店舗削除時の請求明細の扱い

3. **集計・レポート**
   - [ ] 請求タイプ別集計
   - [ ] 店舗別集計
   - [ ] 月次請求サマリー
   - [ ] 税額計算の正確性

---

## 📌 注意事項

### データ特性
- **組織ID**: `12345678-1234-1234-1234-123456789012` (デモ組織)
- **請求月**: 2024年10月（一部データは実績に基づく）
- **税率**: 10%

### 制限事項
- 請求明細は `confirmed_at` が設定された実績データからのみ生成
- 実績データが少ない場合、実績ベースの請求明細も少なくなる

### カスタマイズ
`prisma/seed-billing-patterns.ts` を編集することで、以下を調整可能:
- 請求月の変更
- 各パターンの件数調整
- 金額範囲の変更
- 新しい請求パターンの追加

---

**最終更新**: 2025-10-20  
**バージョン**: 1.0  
**メンテナー**: AI Assistant



