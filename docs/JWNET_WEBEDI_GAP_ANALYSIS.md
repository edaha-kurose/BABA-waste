# 🚨 JWNET WebEDI仕様 ギャップ分析レポート

**作成日**: 2025-10-13  
**ステータス**: 🔴 重要な設計不足あり

---

## 📋 目次

1. [JWNET WebEDI要件の確認状況](#jwnet-webedi要件の確認状況)
2. [請求機能の確認状況](#請求機能の確認状況)
3. [設計ギャップサマリー](#設計ギャップサマリー)
4. [推奨対応策](#推奨対応策)

---

## JWNET WebEDI要件の確認状況

### 1️⃣ 排出事業者・収集業者・処分業者の加入者番号と公開確認番号の組み合わせ設定

#### 現状の実装 ✅ / ❌

| 対象 | テーブル | フィールド | ステータス | 備考 |
|------|---------|-----------|-----------|------|
| **収集業者** | `users` (role=COLLECTOR) | `jwnet_subscriber_id`<br>`jwnet_public_confirmation_id` | ✅ 実装済み | スキーマに存在 |
| **収集業者** | `disposal_sites` | `jwnet_subscriber_id`<br>`jwnet_public_confirmation_id` | ✅ 実装済み | スキーマに存在 |
| **排出事業者** | `organizations` | - | ❌ **未実装** | JWNET情報なし |
| **排出事業者** | `stores` | `emitter_no`のみ | ⚠️ **不十分** | 加入者番号・公開確認番号なし |
| **処分業者** | `disposal_sites` | `jwnet_subscriber_id`<br>`jwnet_public_confirmation_id` | ✅ 実装済み | スキーマに存在 |

#### ギャップ分析 🔴

**重大な問題点:**
1. **排出事業者（Organizations/Stores）のJWNET認証情報が管理されていない**
   - マニフェスト登録時に排出事業者の加入者番号・公開確認番号が必要
   - 現状、手動入力に依存（業務フローとして非現実的）

2. **事業者の役割（排出/収集/処分）とJWNET情報の紐付けが不明確**
   - 同一組織が複数の役割を持つケースに未対応
   - 例: 収集業者が処分も行う場合、両方のJWNET情報が必要

3. **事前登録フローが存在しない**
   - WebEDI仕様では事前に事業者情報を登録し、組み合わせを管理する必要がある
   - 現状、マニフェスト登録時に毎回手入力（エラーリスク大）

#### WebEDI仕様の要件（未実装）

```
📌 WebEDI仕様の要求事項:
1. 排出事業者・収集業者・処分業者の加入者番号と公開確認番号の「組み合わせ」を事前登録
2. 登録された組み合わせのみマニフェスト発行可能
3. 無効な組み合わせはJWNET側でエラー
4. 加入者番号（7桁）+ 公開確認番号（6桁）のペアで事業者を一意に識別
```

**現状**: ❌ **すべて未実装**

---

### 2️⃣ JWNETの廃棄物コードに合わせた廃棄物登録設計

#### 現状の実装 ✅ / ❌

| 項目 | テーブル | フィールド | ステータス | 備考 |
|------|---------|-----------|-----------|------|
| **JWNETコードマスター** | `jwnet_waste_codes` | `waste_code`<br>`waste_name`<br>`waste_category`<br>`unit_code` | ✅ 実装済み | 標準コードマスター |
| **自社ラベル⇄JWNETマッピング** | `item_maps` | `item_label`<br>`jwnet_code` | ✅ 実装済み | 組織ごとのマッピング |
| **廃棄物種別マスター** | `waste_type_masters` | `jwnet_waste_code` | ✅ 実装済み | 収集業者ごとのマスター |
| **事前登録フロー** | - | - | ❌ **未実装** | 登録画面・バリデーション未実装 |
| **マニフェスト登録時のチェック** | API | - | ⚠️ **不十分** | JWNETコード有効性チェックなし |

#### ギャップ分析 🔴

**重大な問題点:**
1. **廃棄物マスターの事前登録フローが未実装**
   - 現状、データベースにテーブルは存在するが、UI画面や管理機能が不足
   - 収集業者が取り扱う廃棄物をJWNETコードと紐付けて事前登録する仕組みが必要

2. **マニフェスト登録時のJWNETコード検証が不十分**
   - 現状の実装（Phase 4-B）では、マニフェスト登録時にJWNETコードの有効性をチェックしていない
   - 無効なコードを送信するとJWNET側でエラー

3. **単位コードの整合性チェックが未実装**
   - JWNETの廃棄物コードごとに使用可能な単位（kg, L, m³等）が決まっている
   - 現状、単位の整合性チェックがない

#### WebEDI仕様の要件（未実装）

```
📌 WebEDI仕様の要求事項:
1. 廃棄物コードはJWNET標準コードを使用（7桁、例: 0010101）
2. 廃棄物コードごとに使用可能な単位が定義されている
3. マニフェスト登録前に、収集業者が取り扱う廃棄物を事前登録
4. 事前登録された廃棄物のみマニフェストに記載可能
5. 廃棄物名称、数量単位、処分方法コードがコードマスターと整合している必要がある
```

**現状**: ⚠️ **データ構造は存在するが、事前登録フロー・バリデーションが未実装**

---

### 3️⃣ JWNET登録完了データを請求データとしてカウントできる仕組み

#### 現状の実装 ✅ / ❌

| 項目 | テーブル | 関連 | ステータス | 備考 |
|------|---------|------|-----------|------|
| **JWNET登録管理** | `jwnet_registrations` | `manifest_no`<br>`receipt_no`<br>`status`<br>`manifest_data` | ✅ 実装済み | Phase 4-B で実装 |
| **請求データ管理** | - | - | ❌ **未実装** | テーブル自体が存在しない |
| **JWNET⇄請求の紐付け** | - | - | ❌ **未実装** | 連携ロジックなし |
| **請求フロー** | - | - | ❌ **未実装** | 収集業者→管理者フローなし |
| **請求Excel出力** | - | - | ❌ **未実装** | 出力機能なし |

#### ギャップ分析 🔴

**重大な問題点:**
1. **請求データモデルが存在しない**
   - JWNET登録完了データを請求データとして扱う仕組みがない
   - 請求金額の計算ロジックが未実装

2. **JWNET登録と請求の紐付けが未設計**
   - `jwnet_registrations` テーブルに請求関連のフィールドがない
   - 請求ステータス（未請求/請求済み/入金済み）の管理ができない

3. **請求種別の設計がない**
   - ①固定金額（月額固定）
   - ②従量請求（単価×数量）
   - ③その他費用（積み込み費用、ゴミ袋代等）
   - これらの請求種別を管理する仕組みが未実装

#### 必要な機能（未実装）

```
📌 請求連携の要求事項:
1. JWNET登録完了データを請求対象として自動カウント
2. 請求ステータス管理（未請求/請求済み/入金済み）
3. 請求種別ごとの金額計算ロジック
4. 請求データの集計・とりまとめ機能
5. 請求Excel出力（収集業者別、期間別）
```

**現状**: ❌ **完全に未実装**

---

## 請求機能の確認状況

### A. 請求フロー（収集業者→システム管理者→Excel出力）

#### 現状の実装 ✅ / ❌

| 項目 | ステータス | 備考 |
|------|-----------|------|
| **収集業者による請求データ登録** | ❌ 未実装 | 画面・APIなし |
| **システム管理者による請求データ確認** | ❌ 未実装 | 画面・APIなし |
| **請求データの集計・とりまとめ** | ❌ 未実装 | ロジックなし |
| **Excel出力機能** | ❌ 未実装 | 出力機能なし |
| **請求承認フロー** | ❌ 未実装 | ワークフローなし |

**現状**: ❌ **完全に未実装**

---

### B. 請求種別

#### 現状の実装 ✅ / ❌

| 請求種別 | 説明 | テーブル設計 | 計算ロジック | UI | ステータス |
|---------|------|-------------|-------------|----|-----------| 
| **①固定金額** | 月額固定の可燃ゴミ・不燃ごみ回収費用など | ❌ なし | ❌ なし | ❌ なし | ❌ 未実装 |
| **②従量請求** | 単価×数量で請求金額を合計する計算ロジック | ❌ なし | ❌ なし | ❌ なし | ❌ 未実装 |
| **③その他費用** | 積み込み費用やゴミ袋代など | ❌ なし | ❌ なし | ❌ なし | ❌ 未実装 |

**現状**: ❌ **完全に未実装**

---

## 設計ギャップサマリー

### 🔴 重大な設計不足（Phase 4-C前に対応必須）

| No. | カテゴリー | 項目 | 重要度 | 影響 |
|-----|----------|------|--------|------|
| 1 | JWNET | 排出事業者のJWNET認証情報管理 | 🔴 高 | マニフェスト登録不可 |
| 2 | JWNET | 事業者組み合わせの事前登録フロー | 🔴 高 | WebEDI仕様不適合 |
| 3 | JWNET | 廃棄物マスターの事前登録フロー | 🔴 高 | WebEDI仕様不適合 |
| 4 | JWNET | マニフェスト登録時のJWNETコード検証 | 🟡 中 | JWNET側でエラー |
| 5 | 請求 | 請求データモデル設計 | 🔴 高 | 請求機能未実装 |
| 6 | 請求 | JWNET登録⇄請求データの紐付け | 🔴 高 | 請求カウント不可 |
| 7 | 請求 | 請求種別（固定/従量/その他）の設計 | 🔴 高 | 請求計算不可 |
| 8 | 請求 | 請求フロー（収集業者→管理者） | 🔴 高 | 業務フロー未実装 |
| 9 | 請求 | 請求Excel出力機能 | 🔴 高 | データ提出不可 |

---

## 推奨対応策

### 🎯 Phase 4-B.5: JWNET WebEDI対応 + 請求基盤実装（Phase 4-C前に実施）

Phase 4-C（Data Visualization）に進む前に、以下の実装を推奨します。

#### 実装優先順位

##### **Priority 1: JWNET WebEDI仕様対応** 🔴（必須）

1. **排出事業者JWNET情報管理**
   - `organizations` テーブルに `jwnet_subscriber_id`, `jwnet_public_confirmation_id` 追加
   - `stores` テーブルにも同様のフィールド追加（店舗単位での管理）
   - マイグレーション作成

2. **事業者組み合わせマスター**
   - 新規テーブル `jwnet_party_combinations` 作成
     - `emitter_id` (排出事業者)
     - `emitter_subscriber_no`, `emitter_public_confirm_no`
     - `transporter_id` (収集業者)
     - `transporter_subscriber_no`, `transporter_public_confirm_no`
     - `disposer_id` (処分業者)
     - `disposer_subscriber_no`, `disposer_public_confirm_no`
     - `is_active`, `valid_from`, `valid_to`
   - 事前登録UI画面作成
   - バリデーションロジック実装

3. **廃棄物マスター事前登録フロー**
   - `waste_type_masters` の管理UI画面作成
   - JWNETコード検索・選択機能
   - 収集業者ごとの廃棄物登録
   - 単位コードの整合性チェック

4. **マニフェスト登録時の検証強化**
   - 事業者組み合わせの有効性チェック
   - JWNETコードの有効性チェック
   - 単位コードの整合性チェック
   - エラーメッセージの改善

##### **Priority 2: 請求機能基盤** 🔴（必須）

1. **請求データモデル設計**
   - 新規テーブル `billing_items` 作成
     ```sql
     billing_items (
       id uuid PRIMARY KEY,
       org_id uuid,
       collector_id uuid,
       billing_month date, -- 請求対象月
       billing_type enum('FIXED', 'METERED', 'OTHER'), -- 請求種別
       item_name text, -- 品目名
       unit_price numeric, -- 単価
       quantity numeric, -- 数量
       amount numeric, -- 金額
       jwnet_registration_id uuid, -- JWNET登録との紐付け
       collection_id uuid, -- 収集実績との紐付け
       status enum('DRAFT', 'SUBMITTED', 'APPROVED', 'PAID'),
       notes text,
       created_at timestamptz,
       ...
     )
     ```

2. **請求種別ごとの計算ロジック**
   - ①固定金額: 店舗数×単価
   - ②従量請求: 数量×単価（JWNETデータから自動取得）
   - ③その他費用: 手動入力

3. **JWNET登録⇄請求データの連携**
   - `jwnet_registrations` に `billing_item_id` フィールド追加
   - JWNET登録完了時に請求データを自動生成
   - ステータス管理（未請求/請求済み/入金済み）

4. **請求フロー実装**
   - 収集業者画面: 請求データ登録・確認
   - システム管理者画面: 請求データとりまとめ・承認
   - 請求ステータス遷移ロジック

5. **請求Excel出力機能**
   - 収集業者別請求データ出力
   - 期間指定（月次/年次）
   - 請求種別別集計
   - Excel形式（xlsx）での出力

---

## 📊 実装工数見積もり

| フェーズ | 内容 | 工数 | 優先度 |
|---------|------|------|--------|
| **Phase 4-B.5-1** | JWNET WebEDI対応 | 大（3-4コンテキスト） | 🔴 最優先 |
| **Phase 4-B.5-2** | 請求機能基盤 | 大（4-5コンテキスト） | 🔴 最優先 |
| **合計** | - | **約7-9コンテキスト** | - |

---

## ⚠️ Phase 4-Cへの影響

**Phase 4-C（Data Visualization）への影響:**
- 請求機能が未実装のため、請求データの可視化ができない
- JWNET WebEDI対応が不十分なため、マニフェストデータの正確性に問題

**推奨アプローチ:**
1. **Phase 4-B.5 を優先実施**（JWNET WebEDI + 請求基盤）
2. **Phase 4-C を後回し**（データ可視化は請求機能実装後の方が価値が高い）

---

## 📝 結論

**Phase 4-B（JWNET Integration）は基本的なAPI通信レイヤーのみの実装であり、実際の業務要件（JWNET WebEDI仕様、請求連携）を満たしていません。**

**Phase 4-C に進む前に、Phase 4-B.5（JWNET WebEDI対応 + 請求基盤実装）を実施することを強く推奨します。**

---

**Last Updated**: 2025-10-13  
**Status**: 🔴 重要な設計不足あり  
**Next Action**: Phase 4-B.5 実装判断

