# Cursor AI Rules (Essential Only)

## ğŸš¨ æœ€å„ªå…ˆãƒ«ãƒ¼ãƒ«

### 1. ã‚³ã‚¹ãƒˆæœ€é©åŒ–
- ç°¡æ½”ãªå¿œç­”ï¼ˆ200ã€œ400æ–‡å­—ï¼‰
- ã‚³ãƒ¼ãƒ‰ä¾‹ã¯5ã€œ10è¡Œã¾ã§
- çµµæ–‡å­—ã¯1ã€œ2å€‹ã¾ã§

### 2. å®Ÿè£…å‰ã®å¿…é ˆç¢ºèª
```bash
pnpm check:schema-sync    # schema.prisma ã¨ DB ã®åŒæœŸç¢ºèª
pnpm check:foreign-keys   # å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®ç¢ºèª
```

**1ã¤ã§ã‚‚ä¸æ˜ãªã‚‰å®Ÿè£…å‰ã«ASK**:
- [ ] ãƒ†ãƒ¼ãƒ–ãƒ«/åˆ—/ENUM ã¯ç¢ºå®šã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] schema.prisma ã¨ DB ã¯åŒæœŸã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¯é©åˆ‡ã‹ï¼Ÿ

---

## ğŸ—„ï¸ Prisma çµ¶å¯¾ãƒ«ãƒ¼ãƒ«

### A. ã‚¹ã‚­ãƒ¼ãƒåŒæœŸï¼ˆCRITICALï¼‰
```bash
# å®Ÿè£…å‰ã«å¿…ãšå®Ÿè¡Œ
pnpm check:schema-sync

# schema.prisma ç·¨é›†å¾Œ
pnpm prisma migrate dev --name descriptive_name
pnpm prisma:generate
```

### B. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ï¼ˆCRITICALï¼‰
```prisma
// âœ… æ­£ã—ã„ä¾‹
model child_table {
  id        String @id
  parent_id String @db.Uuid
  parent    parent_table @relation(fields: [parent_id], references: [id], onDelete: Cascade)
  @@index([parent_id])
}
```

**ç¦æ­¢**: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãªã—ã® `*_id` ã‚«ãƒ©ãƒ 

### C. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥
- **æ¨™æº–**: Prisma Migrate ã®ã¿ä½¿ç”¨
- **ç¦æ­¢**: æ‰‹å‹•SQLã§ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- **ä¾‹å¤–**: RLSãƒãƒªã‚·ãƒ¼ã€ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã€å¤§é‡ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®ã¿

---

## ğŸ”’ èªè¨¼ãƒ»èªå¯ï¼ˆAPIå±¤ï¼‰

### å¿…é ˆãƒ‘ã‚¿ãƒ¼ãƒ³
```typescript
import { getAuthenticatedUser } from '@/lib/auth/session-server'

export async function GET(request: NextRequest) {
  // 1. èªè¨¼ãƒã‚§ãƒƒã‚¯
  const authUser = await getAuthenticatedUser(request)
  if (!authUser) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // 2. èªå¯ãƒã‚§ãƒƒã‚¯
  if (!authUser.isSystemAdmin && !authUser.org_ids.includes(targetOrgId)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }

  // 3. Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const parsed = QuerySchema.parse(...)

  // 4. Prismaã‚¨ãƒ©ãƒ¼åˆ†é›¢
  try {
    const data = await prisma.table.findMany(...)
  } catch (dbError) {
    console.error('[API] Database error:', dbError)
    return NextResponse.json({ error: 'Database error' }, { status: 500 })
  }
}
```

---

## ğŸ“‹ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ¨™æº–

### JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
```typescript
let body
try {
  body = await request.json()
} catch (parseError) {
  return NextResponse.json({ error: 'Invalid JSON' }, { status: 400 })
}
```

### Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
```typescript
try {
  const validated = Schema.parse(body)
} catch (error) {
  if (error instanceof z.ZodError) {
    return NextResponse.json({ error: 'Validation error', details: error.errors }, { status: 400 })
  }
}
```

### Prismaã‚¨ãƒ©ãƒ¼åˆ†é›¢
```typescript
try {
  await prisma.table.create(...)
} catch (dbError) {
  console.error('[API] Database error:', dbError)
  return NextResponse.json({ error: 'Database error occurred' }, { status: 500 })
}
```

---

## ğŸš« çµ¶å¯¾ç¦æ­¢äº‹é …

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
- âŒ æ‰‹å‹•SQLã§ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆPrisma Migrate ã‚’ä½¿ç”¨ï¼‰
- âŒ å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãªã—ã® `*_id` ã‚«ãƒ©ãƒ 
- âŒ `ON DELETE`/`ON UPDATE` ã®æœªæŒ‡å®š
- âŒ schema.prisma ã¨ DB ã®ä¸ä¸€è‡´

### APIå®Ÿè£…
- âŒ èªè¨¼ãƒã‚§ãƒƒã‚¯ãªã—ã®API
- âŒ èªå¯ãƒã‚§ãƒƒã‚¯ãªã—ã®çµ„ç¹”ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
- âŒ Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
- âŒ Prismaã‚¨ãƒ©ãƒ¼ã®æœªåˆ†é›¢ï¼ˆ500ã‚¨ãƒ©ãƒ¼ã®è©³ç´°éœ²å‡ºï¼‰

### ã‚³ãƒ¼ãƒ‰å“è³ª
- âŒ `any` å‹ã®ä¹±ç”¨
- âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çœç•¥
- âŒ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã®è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°

---

## ğŸ§ª E2Eãƒ†ã‚¹ãƒˆå¿…é ˆãƒ«ãƒ¼ãƒ«

### A. èªè¨¼å‡¦ç†ï¼ˆCRITICALï¼‰
```typescript
// âœ… å¿…é ˆ: çµ±ä¸€ã•ã‚ŒãŸE2Eãƒã‚¤ãƒ‘ã‚¹ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨
import { e2eBypassLogin } from '../helpers/auth-helper'

test.beforeEach(async ({ page }) => {
  await e2eBypassLogin(page)
})

// âŒ ç¦æ­¢: ç›´æ¥ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
// âŒ ç¦æ­¢: createServerClient() ã®ç›´æ¥ä½¿ç”¨ï¼ˆE2Eãƒã‚¤ãƒ‘ã‚¹éå¯¾å¿œï¼‰
```

### B. éåŒæœŸå‡¦ç†ã®å¾…æ©Ÿï¼ˆCRITICALï¼‰
```typescript
// âœ… å¿…é ˆ: é©åˆ‡ãªå¾…æ©Ÿå‡¦ç†
await page.waitForLoadState('networkidle', { timeout: 10000 })
await page.locator('.ant-spin-spinning').waitFor({ state: 'hidden' }).catch(() => {})
await page.locator('.ant-layout-sider').waitFor({ state: 'visible' })

// âŒ ç¦æ­¢: waitForTimeout ã®ã¿ã«ä¾å­˜
// âŒ ç¦æ­¢: å¾…æ©Ÿãªã—ã§ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```

### C. UIã‚»ãƒ¬ã‚¯ã‚¿ã®å …ç‰¢æ€§ï¼ˆIMPORTANTï¼‰
```typescript
// âœ… æ¨å¥¨: data-testid å±æ€§ã‚’ä½¿ç”¨
<button data-testid="submit-button">é€ä¿¡</button>
page.locator('[data-testid="submit-button"]')

// âŒ ç¦æ­¢: nth-child ãªã©ã®ä½ç½®ä¾å­˜ã‚»ãƒ¬ã‚¯ã‚¿
```

### D. ãƒ‡ãƒ¼ã‚¿ä¾å­˜ãƒ†ã‚¹ãƒˆã®å‡¦ç†ï¼ˆIMPORTANTï¼‰
```typescript
// âœ… å¿…é ˆ: ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ãƒã‚§ãƒƒã‚¯
const rowCount = await page.locator('tbody tr').count()
if (rowCount === 0) {
  console.log('â­ï¸ ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—')
  test.skip()
}
```

---

## ğŸ“š è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§

å®Ÿè£…æ™‚ã«ä»¥ä¸‹ã‚’å‚ç…§:
- `.cursor/rules/global-rules.md` - å…¨820è¡Œã®è©³ç´°ãƒ«ãƒ¼ãƒ«
- `.cursor/rules/e2e-testing-guidelines.md` - E2Eãƒ†ã‚¹ãƒˆå®Œå…¨ã‚¬ã‚¤ãƒ‰ï¼ˆNEWï¼‰
- `docs/guardrails/SCHEMA_CHANGE_GUIDELINES.md` - ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚
- `docs/guardrails/INFRASTRUCTURE_SETUP_CHECKLIST.md` - ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®šæ™‚
- `docs/guardrails/CURSOR_COMMON_SETTINGS_v3.3_BFF.md` - BFFå®Ÿè£…æ™‚

---

**æœ€çµ‚æ›´æ–°**: 2025-10-22
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1 (Essential + E2E)
